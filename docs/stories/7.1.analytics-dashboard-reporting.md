# Story 7.1: Analytics Dashboard and Reporting

## Status
Done

## Story

**As a** school administrator and parent,
**I want** comprehensive analytics dashboards and detailed reporting capabilities,
**so that** I can make data-driven decisions about meal service operations, understand student preferences, monitor financial performance, and optimize the overall food service experience.

## Acceptance Criteria

1. Executive dashboard with real-time KPIs, operational metrics, and strategic insights for school administrators
2. Financial analytics with revenue tracking, cost analysis, profitability metrics, and budget optimization insights
3. Student analytics with ordering patterns, dietary preferences, engagement metrics, and health impact analysis
4. Operational analytics with delivery performance, vendor efficiency, RFID system metrics, and process optimization
5. Parent engagement analytics with app usage, satisfaction scores, communication effectiveness, and retention metrics
6. Interactive reporting with custom dashboards, drill-down capabilities, and comprehensive data exploration tools
7. Automated insights with anomaly detection, trend analysis, predictive analytics, and recommendation engine
8. Data export and integration with external reporting tools, accounting systems, and business intelligence platforms

## Tasks / Subtasks

- [ ] **Task 1: Executive Dashboard Platform** (AC: 1)
  - [ ] Create comprehensive KPI dashboard with real-time metrics and strategic performance indicators
  - [ ] Implement operational overview with daily summaries, performance trends, and critical alert monitoring
  - [ ] Setup strategic insights with long-term trend analysis, comparative benchmarks, and growth projections
  - [ ] Create executive summary reports with automated generation, key highlight extraction, and actionable recommendations
  - [ ] Implement role-based dashboard customization with personalized views and relevant metric prioritization
  - [ ] Add dashboard analytics with usage tracking, engagement measurement, and optimization insights

- [ ] **Task 2: Financial Analytics Engine** (AC: 2)
  - [ ] Create revenue tracking with detailed breakdown by school, meal type, and subscription plans
  - [ ] Implement cost analysis with vendor expenses, operational costs, and margin calculation
  - [ ] Setup profitability metrics with profit margins, ROI analysis, and financial efficiency indicators
  - [ ] Create budget optimization with variance analysis, forecasting, and resource allocation insights
  - [ ] Implement financial reporting with automated statements, compliance reports, and audit trail generation
  - [ ] Add financial analytics with predictive modeling, cash flow forecasting, and investment recommendations

- [ ] **Task 3: Student Analytics Platform** (AC: 3)
  - [ ] Create ordering pattern analysis with meal preferences, timing trends, and behavioral insights
  - [ ] Implement dietary preference tracking with nutritional choices, allergen management, and health impact assessment
  - [ ] Setup engagement metrics with app usage, order frequency, and satisfaction measurement
  - [ ] Create student segmentation with demographic analysis, preference clustering, and targeted insights
  - [ ] Implement health impact analysis with nutritional trends, dietary improvement tracking, and wellness metrics
  - [ ] Add student analytics with predictive modeling, churn prevention, and personalization recommendations

- [ ] **Task 4: Operational Excellence Analytics** (AC: 4)
  - [ ] Create delivery performance tracking with timing analysis, success rates, and efficiency metrics
  - [ ] Implement vendor efficiency analysis with performance scoring, quality metrics, and relationship optimization
  - [ ] Setup RFID system analytics with scanning accuracy, device performance, and operational efficiency
  - [ ] Create process optimization with bottleneck identification, workflow analysis, and improvement recommendations
  - [ ] Implement quality assurance metrics with satisfaction tracking, issue resolution, and continuous improvement
  - [ ] Add operational analytics with predictive maintenance, capacity planning, and resource optimization

- [ ] **Task 5: Parent Engagement Intelligence** (AC: 5)
  - [ ] Create app usage analytics with engagement patterns, feature adoption, and user journey analysis
  - [ ] Implement satisfaction measurement with survey data, feedback analysis, and sentiment tracking
  - [ ] Setup communication effectiveness with notification engagement, response rates, and channel performance
  - [ ] Create retention analytics with churn prediction, loyalty measurement, and lifetime value calculation
  - [ ] Implement family analytics with household patterns, spending behavior, and preference evolution
  - [ ] Add engagement optimization with personalization insights, experience improvement, and retention strategies

- [ ] **Task 6: Interactive Reporting Platform** (AC: 6)
  - [ ] Create custom dashboard builder with drag-and-drop interface and personalized visualization options
  - [ ] Implement drill-down capabilities with multi-level data exploration and contextual navigation
  - [ ] Setup data exploration tools with advanced filtering, sorting, and dynamic query generation
  - [ ] Create interactive visualizations with charts, graphs, maps, and real-time data representation
  - [ ] Implement collaborative features with dashboard sharing, commenting, and team coordination
  - [ ] Add reporting analytics with usage tracking, performance optimization, and user experience enhancement

- [ ] **Task 7: Automated Insights Engine** (AC: 7)
  - [ ] Create anomaly detection with machine learning algorithms and intelligent alert generation
  - [ ] Implement trend analysis with pattern recognition, seasonal adjustments, and predictive forecasting
  - [ ] Setup predictive analytics with machine learning models, forecast generation, and confidence intervals
  - [ ] Create recommendation engine with actionable insights, optimization suggestions, and strategic guidance
  - [ ] Implement natural language insights with automated narrative generation and executive summaries
  - [ ] Add insights analytics with accuracy tracking, impact measurement, and continuous model improvement

- [ ] **Task 8: Data Integration and Export Platform** (AC: 8)
  - [ ] Create comprehensive data export with multiple formats, scheduling, and automated delivery
  - [ ] Implement external system integration with accounting software, ERP systems, and business intelligence tools
  - [ ] Setup API gateway for third-party integrations with secure access, rate limiting, and comprehensive documentation
  - [ ] Create data warehouse integration with ETL processes, data quality management, and historical preservation
  - [ ] Implement compliance reporting with regulatory requirements, audit trails, and automated compliance verification
  - [ ] Add integration analytics with data quality monitoring, sync performance, and system health tracking

- [ ] **Task 9: Performance and Scalability** (All ACs)
  - [ ] Create high-performance analytics engine supporting real-time processing and large-scale data analysis
  - [ ] Implement scalable architecture with distributed processing, caching optimization, and resource auto-scaling
  - [ ] Setup monitoring and alerting with comprehensive system health tracking and performance optimization
  - [ ] Create data security with encryption, access control, and privacy protection throughout analytics pipeline
  - [ ] Implement backup and recovery with data protection, disaster recovery, and business continuity planning
  - [ ] Add performance analytics with system optimization, capacity planning, and efficiency measurement

- [ ] **Task 10: Advanced Visualization and Intelligence** (All ACs)
  - [ ] Create advanced visualization library with interactive charts, real-time updates, and responsive design
  - [ ] Implement machine learning integration with automated model training, prediction accuracy, and continuous improvement
  - [ ] Setup natural language processing with query understanding, insight generation, and conversational analytics
  - [ ] Create mobile analytics optimization with responsive dashboards, touch interactions, and offline capabilities
  - [ ] Implement real-time streaming analytics with live data processing, instant insights, and immediate alerting
  - [ ] Add intelligence analytics with model performance tracking, accuracy measurement, and optimization recommendations

## Dev Notes

### Technical Context from Architecture

**Analytics and Reporting System Models**:
```typescript
interface AnalyticsDashboard {
  id: string;
  dashboardType: DashboardType;
  widgets: AnalyticsWidget[];
  kpiMetrics: KPIMetric[];
  visualizations: Visualization[];
  insights: AnalyticsInsight[];
  userPreferences: DashboardPreferences;
  permissions: DashboardPermission[];
  analytics: DashboardAnalytics;
  realTimeData: RealTimeDataStream;
}

interface AnalyticsWidget {
  widgetId: string;
  widgetType: WidgetType;
  title: string;
  description: string;
  configuration: WidgetConfiguration;
  dataSource: DataSource;
  visualization: VisualizationConfig;
  filters: FilterConfig[];
  drillDownConfig: DrillDownConfig;
  refreshConfig: RefreshConfig;
  permissions: WidgetPermission[];
  analytics: WidgetAnalytics;
}

interface KPIMetric {
  metricId: string;
  name: string;
  category: MetricCategory;
  value: number;
  previousValue: number;
  trend: TrendDirection;
  target: number;
  calculation: CalculationMethod;
  dimensions: MetricDimension[];
  timeframe: TimeframeConfig;
  alertThresholds: AlertThreshold[];
  historicalData: HistoricalDataPoint[];
}

interface AnalyticsInsight {
  insightId: string;
  insightType: InsightType;
  title: string;
  description: string;
  significance: SignificanceLevel;
  confidence: number;
  recommendations: Recommendation[];
  dataPoints: DataPoint[];
  visualizations: InsightVisualization[];
  createdAt: Date;
  expiresAt?: Date;
  acknowledgedBy?: string[];
}
```

**Financial Analytics Engine**:
```typescript
interface FinancialAnalytics {
  revenueTracking: RevenueTracker;
  costAnalysis: CostAnalyzer;
  profitabilityMetrics: ProfitabilityAnalyzer;
  budgetOptimization: BudgetOptimizer;
  financialReporting: FinancialReporter;
  predictiveModeling: FinancialPredictor;
}

interface RevenueTracker {
  totalRevenue: RevenueMetric;
  revenueBySchool: SchoolRevenueMetric[];
  revenueByMealType: MealTypeRevenueMetric[];
  subscriptionRevenue: SubscriptionRevenueMetric[];
  seasonalTrends: SeasonalTrend[];
  forecastedRevenue: RevenueForecast[];
  revenueAnalytics: RevenueAnalytics;
}

interface CostAnalyzer {
  vendorCosts: VendorCostMetric[];
  operationalCosts: OperationalCostMetric[];
  technologyCosts: TechnologyCostMetric[];
  marketingCosts: MarketingCostMetric[];
  totalCostOfOwnership: TCOMetric;
  costOptimizationOpportunities: CostOptimization[];
  costAnalytics: CostAnalytics;
}

interface ProfitabilityAnalyzer {
  grossProfitMargin: ProfitMarginMetric;
  netProfitMargin: ProfitMarginMetric;
  roiAnalysis: ROIAnalysis[];
  profitabilityBySegment: SegmentProfitability[];
  breakEvenAnalysis: BreakEvenAnalysis;
  profitabilityTrends: ProfitabilityTrend[];
  profitabilityForecasts: ProfitabilityForecast[];
}

interface BudgetOptimizer {
  budgetVarianceAnalysis: VarianceAnalysis[];
  resourceAllocation: ResourceAllocation[];
  costProjections: CostProjection[];
  optimizationRecommendations: OptimizationRecommendation[];
  budgetForecasting: BudgetForecast[];
  allocationEfficiency: AllocationEfficiency[];
}
```

**Student Analytics Platform**:
```typescript
interface StudentAnalytics {
  orderingPatterns: OrderingPatternAnalyzer;
  dietaryPreferences: DietaryPreferenceAnalyzer;
  engagementMetrics: EngagementAnalyzer;
  studentSegmentation: StudentSegmenter;
  healthImpactAnalysis: HealthImpactAnalyzer;
  predictiveModeling: StudentPredictor;
}

interface OrderingPatternAnalyzer {
  mealPreferences: MealPreferenceMetric[];
  timingTrends: TimingTrendMetric[];
  orderFrequency: OrderFrequencyMetric[];
  seasonalPatterns: SeasonalPatternMetric[];
  behavioralInsights: BehavioralInsight[];
  orderingForecasts: OrderingForecast[];
  patternAnalytics: PatternAnalytics;
}

interface DietaryPreferenceAnalyzer {
  nutritionalChoices: NutritionalChoiceMetric[];
  allergenManagement: AllergenMetric[];
  dietaryRestrictions: DietaryRestrictionMetric[];
  healthGoals: HealthGoalMetric[];
  preferenceEvolution: PreferenceEvolutionMetric[];
  dietaryRecommendations: DietaryRecommendation[];
  preferenceAnalytics: PreferenceAnalytics;
}

interface EngagementAnalyzer {
  appUsageMetrics: AppUsageMetric[];
  orderFrequencyMetrics: OrderFrequencyMetric[];
  satisfactionScores: SatisfactionScore[];
  feedbackAnalysis: FeedbackAnalysis[];
  engagementTrends: EngagementTrend[];
  churnRiskAssessment: ChurnRiskAssessment[];
  engagementOptimization: EngagementOptimization[];
}

interface StudentSegmenter {
  demographicSegments: DemographicSegment[];
  behavioralSegments: BehavioralSegment[];
  preferenceSegments: PreferenceSegment[];
  engagementSegments: EngagementSegment[];
  valueSegments: ValueSegment[];
  segmentInsights: SegmentInsight[];
  targetingRecommendations: TargetingRecommendation[];
}
```

**Operational Analytics Engine**:
```typescript
interface OperationalAnalytics {
  deliveryPerformance: DeliveryPerformanceAnalyzer;
  vendorEfficiency: VendorEfficiencyAnalyzer;
  rfidSystemAnalytics: RFIDSystemAnalyzer;
  processOptimization: ProcessOptimizer;
  qualityAssurance: QualityAssuranceAnalyzer;
  operationalPredictor: OperationalPredictor;
}

interface DeliveryPerformanceAnalyzer {
  timingAnalysis: TimingAnalysisMetric[];
  successRates: SuccessRateMetric[];
  efficiencyMetrics: EfficiencyMetric[];
  deliveryTrends: DeliveryTrendMetric[];
  performanceBySchool: SchoolPerformanceMetric[];
  deliveryOptimization: DeliveryOptimization[];
  performanceForecasts: PerformanceForecast[];
}

interface VendorEfficiencyAnalyzer {
  performanceScoring: VendorPerformanceScore[];
  qualityMetrics: VendorQualityMetric[];
  reliabilityMetrics: VendorReliabilityMetric[];
  costEfficiency: VendorCostEfficiency[];
  relationshipOptimization: RelationshipOptimization[];
  vendorRecommendations: VendorRecommendation[];
  vendorAnalytics: VendorAnalytics;
}

interface RFIDSystemAnalyzer {
  scanningAccuracy: ScanningAccuracyMetric[];
  devicePerformance: DevicePerformanceMetric[];
  systemUptime: SystemUptimeMetric[];
  errorAnalysis: ErrorAnalysisMetric[];
  operationalEfficiency: OperationalEfficiencyMetric[];
  maintenanceInsights: MaintenanceInsight[];
  systemOptimization: SystemOptimization[];
}

interface ProcessOptimizer {
  bottleneckIdentifier: BottleneckIdentifier;
  workflowAnalyzer: WorkflowAnalyzer;
  efficiencyMeasurer: EfficiencyMeasurer;
  improvementRecommender: ImprovementRecommender;
  processForecaster: ProcessForecaster;
  optimizationTracker: OptimizationTracker;
}
```

**Interactive Reporting Platform**:
```typescript
interface InteractiveReporting {
  customDashboardBuilder: CustomDashboardBuilder;
  drillDownEngine: DrillDownEngine;
  dataExplorer: DataExplorer;
  visualizationEngine: VisualizationEngine;
  collaborationPlatform: CollaborationPlatform;
  reportingAnalytics: ReportingAnalytics;
}

interface CustomDashboardBuilder {
  widgetLibrary: WidgetLibrary;
  layoutEngine: LayoutEngine;
  configurationManager: ConfigurationManager;
  templateManager: TemplateManager;
  personalizationEngine: PersonalizationEngine;
  builderAnalytics: BuilderAnalytics;
}

interface DrillDownEngine {
  hierarchicalNavigation: HierarchicalNavigation;
  contextualFiltering: ContextualFiltering;
  dataLinking: DataLinking;
  breadcrumbTracker: BreadcrumbTracker;
  drillDownAnalytics: DrillDownAnalytics;
  navigationOptimizer: NavigationOptimizer;
}

interface DataExplorer {
  advancedFiltering: AdvancedFiltering;
  dynamicSorting: DynamicSorting;
  queryBuilder: QueryBuilder;
  dataDiscovery: DataDiscovery;
  explorationTracking: ExplorationTracking;
  explorationAnalytics: ExplorationAnalytics;
}

interface VisualizationEngine {
  chartLibrary: ChartLibrary;
  interactiveCharts: InteractiveChart[];
  realTimeVisualization: RealTimeVisualization;
  responsiveDesign: ResponsiveDesign;
  animationEngine: AnimationEngine;
  visualizationAnalytics: VisualizationAnalytics;
}
```

**Automated Insights Engine**:
```typescript
interface AutomatedInsights {
  anomalyDetector: AnomalyDetector;
  trendAnalyzer: TrendAnalyzer;
  predictiveAnalytics: PredictiveAnalytics;
  recommendationEngine: RecommendationEngine;
  naturalLanguageInsights: NLInsights;
  insightsAnalytics: InsightsAnalytics;
}

interface AnomalyDetector {
  machineLearningAlgorithms: MLAlgorithm[];
  anomalyClassifier: AnomalyClassifier;
  alertGenerator: AlertGenerator;
  contextAnalyzer: ContextAnalyzer;
  anomalyTracker: AnomalyTracker;
  detectionOptimizer: DetectionOptimizer;
}

interface TrendAnalyzer {
  patternRecognition: PatternRecognition;
  seasonalAdjustment: SeasonalAdjustment;
  trendForecasting: TrendForecasting;
  cycleDetection: CycleDetection;
  trendVisualization: TrendVisualization;
  trendAnalytics: TrendAnalytics;
}

interface PredictiveAnalytics {
  forecastingModels: ForecastingModel[];
  confidenceIntervals: ConfidenceInterval[];
  scenarioAnalysis: ScenarioAnalysis[];
  predictiveVisualization: PredictiveVisualization;
  modelValidation: ModelValidation;
  predictionTracking: PredictionTracking;
}

interface RecommendationEngine {
  actionableInsights: ActionableInsight[];
  optimizationSuggestions: OptimizationSuggestion[];
  strategicGuidance: StrategicGuidance[];
  recommendationScoring: RecommendationScoring;
  implementationTracking: ImplementationTracking;
  recommendationAnalytics: RecommendationAnalytics;
}

interface NLInsights {
  narrativeGenerator: NarrativeGenerator;
  executiveSummary: ExecutiveSummaryGenerator;
  insightExtractor: InsightExtractor;
  languageOptimizer: LanguageOptimizer;
  readabilityAnalyzer: ReadabilityAnalyzer;
  narrativeAnalytics: NarrativeAnalytics;
}
```

**Database Schema Extensions**:
```sql
-- Analytics dashboards and configurations
CREATE TABLE analytics_dashboards (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    dashboard_id VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    dashboard_type VARCHAR(50) NOT NULL,
    owner_id UUID NOT NULL REFERENCES users(id),
    configuration JSONB NOT NULL,
    widgets JSONB NOT NULL,
    permissions JSONB NOT NULL,
    analytics JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    INDEX idx_analytics_dashboards_owner_type(owner_id, dashboard_type)
);

-- Analytics widgets and visualizations
CREATE TABLE analytics_widgets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    widget_id VARCHAR(100) NOT NULL UNIQUE,
    dashboard_id UUID NOT NULL REFERENCES analytics_dashboards(id),
    widget_type VARCHAR(50) NOT NULL,
    title VARCHAR(255) NOT NULL,
    configuration JSONB NOT NULL,
    data_source JSONB NOT NULL,
    visualization_config JSONB NOT NULL,
    position JSONB NOT NULL,
    permissions JSONB NOT NULL,
    analytics JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- KPI metrics with historical tracking
CREATE TABLE kpi_metrics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    metric_id VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    category VARCHAR(50) NOT NULL,
    value DECIMAL(12,4) NOT NULL,
    previous_value DECIMAL(12,4),
    target DECIMAL(12,4),
    calculation_method VARCHAR(100) NOT NULL,
    dimensions JSONB NOT NULL,
    timeframe JSONB NOT NULL,
    alert_thresholds JSONB DEFAULT '[]',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    INDEX idx_kpi_metrics_category_created(category, created_at)
);

-- Historical data points for trending
CREATE TABLE metric_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    metric_id UUID NOT NULL REFERENCES kpi_metrics(id),
    value DECIMAL(12,4) NOT NULL,
    dimensions JSONB NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    aggregation_period VARCHAR(20),
    data_quality_score DECIMAL(3,2),
    INDEX idx_metric_history_metric_timestamp(metric_id, timestamp)
);

-- Automated insights and recommendations
CREATE TABLE analytics_insights (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    insight_id VARCHAR(100) NOT NULL UNIQUE,
    insight_type VARCHAR(50) NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    significance VARCHAR(20) NOT NULL,
    confidence DECIMAL(3,2) NOT NULL,
    recommendations JSONB DEFAULT '[]',
    data_points JSONB NOT NULL,
    visualizations JSONB DEFAULT '[]',
    acknowledged_by JSONB DEFAULT '[]',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE,
    INDEX idx_analytics_insights_type_significance(insight_type, significance)
);

-- Financial analytics data
CREATE TABLE financial_analytics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    metric_type VARCHAR(50) NOT NULL,
    metric_value DECIMAL(15,4) NOT NULL,
    currency VARCHAR(3) DEFAULT 'INR',
    dimensions JSONB NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    aggregation_period VARCHAR(20),
    school_id UUID REFERENCES schools(id),
    vendor_id UUID REFERENCES vendors(id),
    INDEX idx_financial_analytics_type_timestamp(metric_type, timestamp),
    INDEX idx_financial_analytics_school_timestamp(school_id, timestamp)
);

-- Student analytics data
CREATE TABLE student_analytics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id UUID NOT NULL REFERENCES students(id),
    metric_type VARCHAR(50) NOT NULL,
    metric_value DECIMAL(12,4) NOT NULL,
    dimensions JSONB NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    aggregation_period VARCHAR(20),
    privacy_level VARCHAR(20) DEFAULT 'aggregated',
    INDEX idx_student_analytics_student_type(student_id, metric_type),
    INDEX idx_student_analytics_type_timestamp(metric_type, timestamp)
);

-- Operational analytics data
CREATE TABLE operational_analytics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    operation_type VARCHAR(50) NOT NULL,
    metric_type VARCHAR(50) NOT NULL,
    metric_value DECIMAL(12,4) NOT NULL,
    dimensions JSONB NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    aggregation_period VARCHAR(20),
    school_id UUID REFERENCES schools(id),
    vendor_id UUID REFERENCES vendors(id),
    device_id VARCHAR(255),
    INDEX idx_operational_analytics_type_timestamp(metric_type, timestamp),
    INDEX idx_operational_analytics_operation_school(operation_type, school_id)
);

-- Parent engagement analytics
CREATE TABLE parent_engagement_analytics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    parent_id UUID NOT NULL REFERENCES users(id),
    engagement_type VARCHAR(50) NOT NULL,
    metric_value DECIMAL(12,4) NOT NULL,
    dimensions JSONB NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    aggregation_period VARCHAR(20),
    session_id VARCHAR(255),
    device_info JSONB,
    INDEX idx_parent_engagement_parent_type(parent_id, engagement_type),
    INDEX idx_parent_engagement_type_timestamp(engagement_type, timestamp)
);

-- Custom reports and exports
CREATE TABLE custom_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    report_id VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    report_type VARCHAR(50) NOT NULL,
    created_by UUID NOT NULL REFERENCES users(id),
    configuration JSONB NOT NULL,
    schedule JSONB,
    export_settings JSONB NOT NULL,
    last_generated TIMESTAMP WITH TIME ZONE,
    next_scheduled TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Report generation history
CREATE TABLE report_generations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    report_id UUID NOT NULL REFERENCES custom_reports(id),
    generation_id VARCHAR(100) NOT NULL UNIQUE,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    file_url TEXT,
    file_size BIGINT,
    generation_time INTEGER,
    error_details JSONB,
    downloaded_by JSONB DEFAULT '[]',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE,
    INDEX idx_report_generations_report_created(report_id, created_at)
);

-- Analytics permissions and access control
CREATE TABLE analytics_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    permission_type VARCHAR(50) NOT NULL,
    resource_type VARCHAR(50) NOT NULL,
    resource_id VARCHAR(255),
    permissions JSONB NOT NULL,
    granted_by UUID NOT NULL REFERENCES users(id),
    granted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE,
    UNIQUE(user_id, permission_type, resource_type, resource_id)
);

-- Performance indexes for analytics operations
CREATE INDEX idx_analytics_dashboards_active_updated ON analytics_dashboards(is_active, updated_at);
CREATE INDEX idx_analytics_widgets_dashboard_position ON analytics_widgets(dashboard_id, position);
CREATE INDEX idx_kpi_metrics_value_target ON kpi_metrics(value, target);
CREATE INDEX idx_analytics_insights_created_expires ON analytics_insights(created_at, expires_at);
CREATE INDEX idx_financial_analytics_currency_value ON financial_analytics(currency, metric_value);
CREATE INDEX idx_student_analytics_privacy_timestamp ON student_analytics(privacy_level, timestamp);
CREATE INDEX idx_operational_analytics_device_timestamp ON operational_analytics(device_id, timestamp);
CREATE INDEX idx_parent_engagement_session_timestamp ON parent_engagement_analytics(session_id, timestamp);
CREATE INDEX idx_custom_reports_schedule_active ON custom_reports(next_scheduled, is_active);
CREATE INDEX idx_report_generations_status_completed ON report_generations(status, completed_at);
CREATE INDEX idx_analytics_permissions_user_expires ON analytics_permissions(user_id, expires_at);
```

**API Endpoints** [Source: architecture.md#rest-api-specification]:
- **GET /analytics/dashboard/{dashboardId}**: Get dashboard configuration and data
- **POST /analytics/dashboard**: Create custom dashboard with widgets and permissions
- **GET /analytics/kpis**: Get real-time KPI metrics with trending data
- **GET /analytics/financial**: Get financial analytics with revenue and cost breakdown
- **GET /analytics/students**: Get student analytics with privacy-compliant aggregations
- **GET /analytics/operational**: Get operational performance metrics and insights
- **GET /analytics/engagement**: Get parent engagement and satisfaction metrics
- **POST /analytics/insights/generate**: Generate automated insights and recommendations
- **GET /analytics/export/{reportId}**: Export analytics data in specified format
- **POST /analytics/reports/schedule**: Schedule automated report generation

### File Structure Context

**Analytics Dashboard Components** [Source: architecture.md#unified-project-structure]:
```
apps/mobile/src/
├── screens/analytics/
│   ├── AnalyticsDashboardScreen.tsx    # Main analytics dashboard interface
│   ├── FinancialAnalyticsScreen.tsx    # Financial metrics and insights
│   ├── StudentInsightsScreen.tsx       # Student behavior and preferences
│   ├── EngagementAnalyticsScreen.tsx   # Parent engagement metrics
│   └── CustomReportsScreen.tsx         # Custom report generation and export
├── components/analytics/
│   ├── KPIWidget.tsx                   # Key performance indicator display
│   ├── TrendChart.tsx                  # Trend visualization with interactions
│   ├── MetricCard.tsx                  # Individual metric display card
│   ├── InteractiveChart.tsx            # Interactive data visualization
│   ├── InsightCard.tsx                 # Automated insight presentation
│   ├── DrillDownTable.tsx              # Detailed data exploration table
│   ├── FilterPanel.tsx                 # Advanced filtering interface
│   ├── ExportButton.tsx                # Data export functionality
│   ├── DashboardBuilder.tsx            # Custom dashboard creation
│   └── RealtimeIndicator.tsx           # Real-time data status indicator
├── hooks/analytics/
│   ├── useAnalyticsDashboard.tsx       # Dashboard state and configuration
│   ├── useKPIMetrics.tsx               # KPI data fetching and updates
│   ├── useFinancialAnalytics.tsx       # Financial metrics and calculations
│   ├── useStudentAnalytics.tsx         # Student insights and patterns
│   ├── useOperationalAnalytics.tsx     # Operational performance metrics
│   ├── useEngagementAnalytics.tsx      # Parent engagement tracking
│   ├── useCustomReports.tsx            # Report generation and management
│   └── useAnalyticsInsights.tsx        # Automated insights and recommendations
├── services/
│   ├── analyticsService.ts             # Core analytics API integration
│   ├── dashboardService.ts             # Dashboard configuration management
│   ├── metricsService.ts               # Metrics calculation and aggregation
│   ├── insightsService.ts              # Insights generation and processing
│   ├── exportService.ts                # Data export and formatting
│   └── visualizationService.ts         # Chart and visualization utilities
└── utils/
    ├── analyticsHelpers.ts             # Analytics utility functions
    ├── chartConfigurations.ts          # Chart configuration presets
    ├── dataFormatters.ts               # Data formatting and presentation
    ├── colorPalettes.ts                # Consistent color schemes
    └── calculationUtils.ts             # Mathematical calculations and aggregations
```

**Backend Analytics Services** [Source: architecture.md#unified-project-structure]:
```
apps/api/src/
├── functions/analytics/
│   ├── generateDashboard.ts            # Dashboard data generation and rendering
│   ├── calculateKPIs.ts                # KPI calculation and trending analysis
│   ├── processFinancialAnalytics.ts    # Financial metrics computation
│   ├── generateStudentInsights.ts      # Student analytics with privacy protection
│   ├── processOperationalMetrics.ts    # Operational performance analysis
│   ├── calculateEngagementMetrics.ts   # Parent engagement analysis
│   ├── generateAutomatedInsights.ts    # AI-powered insights generation
│   ├── exportAnalyticsData.ts          # Data export and formatting
│   ├── scheduleReports.ts              # Automated report generation
│   └── processRealTimeMetrics.ts       # Real-time data processing
├── services/
│   ├── analyticsEngineService.ts       # Core analytics processing engine
│   ├── dashboardManagementService.ts   # Dashboard configuration and permissions
│   ├── metricsCalculationService.ts    # Metrics computation and aggregation
│   ├── insightsGenerationService.ts    # Automated insights and recommendations
│   ├── dataExportService.ts            # Export formatting and delivery
│   ├── visualizationService.ts         # Chart data preparation and optimization
│   ├── predictionService.ts            # Predictive analytics and forecasting
│   ├── anomalyDetectionService.ts      # Anomaly detection and alerting
│   ├── reportingService.ts             # Report generation and scheduling
│   └── analyticsComplianceService.ts   # Data privacy and compliance
└── repositories/
    ├── analyticsRepository.ts           # Analytics data storage and retrieval
    ├── dashboardRepository.ts           # Dashboard configuration storage
    ├── metricsRepository.ts             # Metrics data management
    ├── insightsRepository.ts            # Insights storage and tracking
    ├── reportRepository.ts              # Report generation history
    ├── exportRepository.ts              # Export job management
    └── permissionsRepository.ts         # Analytics access control
```

### Business Logic Requirements

**Executive Dashboard Excellence**:
- Real-time KPI monitoring with automated refresh and alert generation
- Strategic insights with trend analysis, comparative benchmarking, and growth projections
- Operational overview with daily summaries, performance trends, and critical metrics
- Role-based customization with personalized views and relevant metric prioritization

**Financial Intelligence**:
- Comprehensive revenue tracking with detailed breakdown and forecasting capabilities
- Cost analysis with vendor expenses, operational efficiency, and margin optimization
- Profitability metrics with ROI analysis, break-even calculations, and investment recommendations
- Budget optimization with variance analysis, resource allocation, and financial planning

**Student Behavior Analytics**:
- Ordering pattern analysis with meal preferences, timing trends, and behavioral insights
- Dietary preference tracking with nutritional choices, health impact assessment, and wellness monitoring
- Engagement measurement with app usage, satisfaction scoring, and retention analysis
- Student segmentation with demographic clustering, preference analysis, and targeted insights

**Operational Optimization**:
- Delivery performance tracking with efficiency metrics, success rates, and optimization recommendations
- Vendor efficiency analysis with performance scoring, quality assessment, and relationship optimization
- RFID system analytics with accuracy monitoring, device performance, and maintenance insights
- Process optimization with bottleneck identification, workflow analysis, and improvement strategies

### Previous Story Dependencies

**Dependencies from Epic 1**:
- **Story 1.2**: Authentication system for secure analytics access and user identification
- **Story 1.3**: User management for role-based analytics permissions and access control
- **Story 1.4**: API Gateway for analytics endpoints and external system integrations

**Dependencies from Epic 2**:
- **Story 2.1**: Product catalog for meal preference analytics and dietary trend analysis
- **Story 2.2**: Menu planning for schedule optimization and demand forecasting analytics
- **Story 2.3**: Nutritional information for health impact analysis and wellness tracking

**Dependencies from Epic 3**:
- **Order Management**: Order analytics with pattern recognition and revenue tracking
- **Shopping Cart**: Cart abandonment analytics and conversion optimization
- **Checkout Process**: Payment analytics and transaction performance metrics

**Dependencies from Epic 4**:
- **RFID Delivery Verification**: Delivery performance analytics and efficiency measurement
- **Order Tracking**: Operational analytics and customer satisfaction tracking

**Dependencies from Epic 5**:
- **Payment Gateway Integration**: Financial analytics and transaction performance metrics
- **Billing and Invoice Management**: Revenue analytics and billing efficiency tracking
- **Subscription and Recurring Payments**: Subscription analytics and customer lifetime value

**Dependencies from Epic 6**:
- **Notification Infrastructure**: Communication analytics and engagement measurement
- **WhatsApp Business API Integration**: WhatsApp engagement analytics and effectiveness tracking
- **In-App Notification System**: App engagement analytics and user behavior tracking

### Integration Points

**Mobile App Integration**:
- Interactive dashboards with touch-optimized interface and responsive design
- Real-time data visualization with smooth animations and user-friendly navigation
- Custom report generation with mobile-optimized export and sharing capabilities
- Insights presentation with actionable recommendations and implementation guidance

**Admin Portal Integration**:
- Comprehensive analytics suite with advanced filtering and drill-down capabilities
- Custom dashboard builder with drag-and-drop interface and template management
- Automated report scheduling with email delivery and notification management
- Role-based access control with permission management and audit trails

**External System Integration**:
- Accounting software integration with financial data synchronization and compliance reporting
- Business intelligence platform connectivity with data warehouse integration
- ERP system integration with operational data exchange and process optimization
- Third-party analytics tools with API access and data export capabilities

**Future Epic Integration**:
- Machine learning integration with predictive analytics and recommendation engines
- Advanced reporting with natural language generation and executive summaries
- Real-time alerting with anomaly detection and proactive notification systems
- Compliance monitoring with regulatory reporting and audit trail management

## Testing

### Testing Standards
- **Location**: Analytics tests in `apps/mobile/__tests__/screens/analytics/` and `apps/api/__tests__/functions/analytics/`
- **Frameworks**: Jest with React Native Testing Library, analytics testing utilities
- **Coverage**: 100% coverage for calculations, 95% for visualizations, 90% for dashboards
- **Performance Testing**: Load testing for large datasets and real-time processing

### Specific Test Requirements
- **Unit Tests**: All analytics services, calculation engines, visualization components
- **Integration Tests**: Complete analytics workflows, dashboard generation, export functionality
- **Performance Tests**: Large dataset processing, real-time updates, concurrent user access
- **Security Tests**: Data access control, privacy compliance, audit trail validation
- **Accessibility Tests**: Screen reader support, keyboard navigation, visual indicators

### Test Scenarios
1. **Dashboard Generation**: Real-time data loading, widget configuration, permission validation
2. **KPI Calculations**: Metric computation, trend analysis, alert threshold validation
3. **Financial Analytics**: Revenue tracking, cost analysis, profitability calculations
4. **Student Analytics**: Privacy-compliant aggregation, behavioral pattern recognition
5. **Operational Analytics**: Performance measurement, efficiency calculation, optimization insights
6. **Interactive Reporting**: Custom dashboard creation, drill-down navigation, data exploration
7. **Automated Insights**: Anomaly detection, trend analysis, recommendation generation
8. **Data Export**: Format conversion, scheduling, delivery validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-02 | 1.0 | Initial story creation with comprehensive analytics dashboard and reporting context | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated during development*

### Debug Log References
*To be populated during development*

### Completion Notes List
*To be populated during development*

### File List
*To be populated during development*

## QA Results

*Results from QA Agent review will be populated here after story implementation*