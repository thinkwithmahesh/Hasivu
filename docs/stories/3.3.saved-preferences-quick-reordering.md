# Story 3.3: Saved Preferences and Quick Reordering

## Status

Done

## Story

**As a** parent,
**I want** saved meal preferences and one-touch reordering,
**so that** I can efficiently manage recurring meal orders without repetitive selection processes.

## Acceptance Criteria

1. Child dietary profile management with preferences, restrictions, and portion sizes
2. Meal history tracking with rating and feedback collection
3. Favorite meals list with easy reordering and modification capabilities
4. Smart suggestions based on ordering history and seasonal availability
5. Recurring order templates with automatic scheduling and customization options
6. Family meal planning with multiple children support and individual preferences
7. Quick action buttons for common orders and emergency meal selection
8. Preference learning system adapting to usage patterns and feedback

## Tasks / Subtasks

- [ ] **Task 1: Child Dietary Profile Management** (AC: 1)
  - [ ] Create comprehensive child profile interface with dietary restrictions and allergies
  - [ ] Implement preference tracking for meal types, ingredients, and preparation styles
  - [ ] Setup portion size management with age-appropriate recommendations and adjustments
  - [ ] Create nutritional goal setting with pediatric guidelines and family input
  - [ ] Implement medical dietary requirement management with healthcare provider integration
  - [ ] Add growth tracking integration with portion size and nutritional need adjustments

- [ ] **Task 2: Meal History and Rating System** (AC: 2)
  - [ ] Create comprehensive meal history with detailed consumption and satisfaction tracking
  - [ ] Implement rating and feedback system with nutrition, taste, and satisfaction metrics
  - [ ] Setup photo-based meal feedback with visual consumption tracking
  - [ ] Create family feedback aggregation with parent and child input coordination
  - [ ] Implement trend analysis for meal preferences and dietary pattern recognition
  - [ ] Add feedback-based recommendation improvement with machine learning integration

- [ ] **Task 3: Favorites Management System** (AC: 3)
  - [ ] Create favorites list with categorization by meal type, season, and occasion
  - [ ] Implement quick reorder functionality with automatic availability checking
  - [ ] Setup favorite modification interface with ingredient substitutions and customizations
  - [ ] Create family favorite sharing with approval workflows and preference coordination
  - [ ] Implement smart favorite suggestions based on ordering patterns and seasonal trends
  - [ ] Add favorite meal analytics with popularity tracking and optimization recommendations

- [ ] **Task 4: Smart Suggestion Engine** (AC: 4)
  - [ ] Create ML-based recommendation engine using historical ordering data and preferences
  - [ ] Implement seasonal availability integration with menu planning and inventory systems
  - [ ] Setup contextual suggestions based on weather, events, and family schedule
  - [ ] Create nutritional balance suggestions with weekly and monthly dietary goal tracking
  - [ ] Implement variety optimization preventing meal repetition and encouraging exploration
  - [ ] Add peer recommendation system with anonymous family preference sharing

- [ ] **Task 5: Recurring Order Templates** (AC: 5)
  - [ ] Create recurring order template system with flexible scheduling patterns
  - [ ] Implement automatic scheduling with school calendar integration and conflict resolution
  - [ ] Setup template customization with seasonal menu adaptation and preference evolution
  - [ ] Create subscription-like functionality with automatic ordering and payment processing
  - [ ] Implement template sharing between family members with role-based permissions
  - [ ] Add template optimization with cost analysis and nutritional balance recommendations

- [ ] **Task 6: Family Meal Planning Coordination** (AC: 6)
  - [ ] Create multi-child meal planning interface with individual preference management
  - [ ] Implement family calendar integration with shared meal planning and coordination
  - [ ] Setup sibling preference coordination with compromise suggestion algorithms
  - [ ] Create family budget management with spending tracking and optimization recommendations
  - [ ] Implement shared shopping lists with ingredient consolidation and cost optimization
  - [ ] Add family nutrition tracking with collective goal setting and progress monitoring

- [ ] **Task 7: Quick Action Interface** (AC: 7)
  - [ ] Create one-touch reorder buttons for frequently ordered meals and combinations
  - [ ] Implement emergency meal ordering with expedited delivery and simplified checkout
  - [ ] Setup quick modification interface for last-minute dietary changes and requests
  - [ ] Create gesture-based ordering with swipe actions and voice command integration
  - [ ] Implement smart shortcuts based on time of day, day of week, and usage patterns
  - [ ] Add customizable quick action dashboard with personalized workflow optimization

- [ ] **Task 8: Adaptive Preference Learning** (AC: 8)
  - [ ] Create machine learning system tracking usage patterns and preference evolution
  - [ ] Implement feedback integration with continuous recommendation improvement
  - [ ] Setup behavioral analysis with ordering pattern recognition and prediction
  - [ ] Create preference decay algorithms accounting for changing tastes and growth
  - [ ] Implement family learning with shared preference discovery and adaptation
  - [ ] Add explainable AI features helping parents understand recommendation reasoning

- [ ] **Task 9: Integration and Performance Optimization** (All ACs)
  - [ ] Create seamless integration with menu browsing and shopping cart systems
  - [ ] Implement real-time preference updates with instant recommendation refresh
  - [ ] Setup offline preference management with synchronization and conflict resolution
  - [ ] Create preference backup and migration for device changes and app updates
  - [ ] Implement performance optimization for large preference datasets and complex algorithms
  - [ ] Add preference analytics dashboard for parents with insights and optimization suggestions

## Dev Notes

### Technical Context from Architecture

**Preference Management Data Models**:

```typescript
interface ChildDietaryProfile {
  childId: string;
  parentId: string;
  personalInfo: ChildPersonalInfo;
  dietaryRestrictions: DietaryRestrictions;
  nutritionalGoals: NutritionalGoals;
  preferences: ChildPreferences;
  medicalConsiderations: MedicalConsiderations;
  growthTracking: GrowthTracking;
  profileVersion: number;
  lastUpdated: Date;
}

interface ChildPreferences {
  mealTypePreferences: MealTypePreference[];
  ingredientPreferences: IngredientPreference[];
  flavorProfiles: FlavorProfile[];
  texturePreferences: TexturePreference[];
  temperaturePreferences: TemperaturePreference[];
  presentationPreferences: PresentationPreference[];
  portionSizePreferences: PortionSizePreference[];
  timingPreferences: MealTimingPreference[];
}

interface MealHistory {
  id: string;
  childId: string;
  menuItemId: string;
  orderDate: Date;
  consumptionDate: Date;
  quantity: number;
  portionSize: PortionSize;
  consumptionLevel: ConsumptionLevel;
  satisfaction: SatisfactionRating;
  feedback: MealFeedback;
  photos: string[];
  nutritionalImpact: NutritionalImpact;
}

interface FavoriteMeal {
  id: string;
  childId: string;
  menuItemId: string;
  customizations: MealCustomization[];
  frequency: number;
  lastOrdered: Date;
  averageRating: number;
  seasonalAvailability: SeasonalPattern;
  reorderCount: number;
  shareableWithFamily: boolean;
}
```

**Smart Suggestion Engine** [Source: architecture.md#recommendation-engine]:

```typescript
interface RecommendationEngine {
  userId: string;
  childProfiles: ChildDietaryProfile[];
  historicalData: MealHistory[];
  preferences: UserPreferences;
  contextualFactors: ContextualFactors;
  algorithms: RecommendationAlgorithm[];
}

interface RecommendationAlgorithm {
  name: string;
  type: 'collaborative' | 'content-based' | 'hybrid' | 'contextual';
  weight: number;
  parameters: AlgorithmParameters;
  performance: AlgorithmPerformance;
}

interface SmartSuggestion {
  menuItemId: string;
  confidenceScore: number;
  reasoningFactors: ReasoningFactor[];
  nutritionalFit: number;
  preferenceFit: number;
  seasonalRelevance: number;
  familyCompatibility: number;
  noveltyScore: number;
  suggestedCustomizations: SuggestedCustomization[];
}

interface RecurringOrderTemplate {
  id: string;
  parentId: string;
  name: string;
  description: string;
  childIds: string[];
  mealPattern: MealPattern[];
  schedulingRules: SchedulingRule[];
  budgetConstraints: BudgetConstraint[];
  nutritionalTargets: NutritionalTarget[];
  flexibility: TemplateFlexibility;
  isActive: boolean;
  performance: TemplatePerformance;
}
```

**Family Coordination Models**:

```typescript
interface FamilyMealPlan {
  id: string;
  familyId: string;
  planPeriod: DateRange;
  childPlans: ChildMealPlan[];
  sharedMeals: SharedMeal[];
  budgetAllocation: BudgetAllocation;
  nutritionalGoals: FamilyNutritionalGoals;
  preferences: FamilyPreferences;
  conflicts: PlanningConflict[];
  resolutions: ConflictResolution[];
}

interface ChildMealPlan {
  childId: string;
  scheduledMeals: ScheduledMeal[];
  individualPreferences: IndividualPreferences;
  specialRequirements: SpecialRequirement[];
  flexibilityRules: FlexibilityRule[];
  backupOptions: BackupMealOption[];
}

interface QuickActionConfiguration {
  parentId: string;
  quickActions: QuickAction[];
  emergencyOptions: EmergencyOption[];
  voiceCommands: VoiceCommand[];
  gestureSettings: GestureSettings;
  contextualRules: ContextualRule[];
  usageAnalytics: QuickActionAnalytics;
}

interface PreferenceLearningSystem {
  userId: string;
  learningModels: LearningModel[];
  behaviorPatterns: BehaviorPattern[];
  feedbackLoop: FeedbackLoop;
  adaptationRules: AdaptationRule[];
  explainabilityFeatures: ExplainabilityFeature[];
  performanceMetrics: LearningPerformanceMetrics;
}
```

**Database Schema Extensions**:

```sql
-- Child dietary profiles with comprehensive preference tracking
CREATE TABLE child_dietary_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID NOT NULL REFERENCES users(id),
    parent_id UUID NOT NULL REFERENCES users(id),
    personal_info JSONB NOT NULL,
    dietary_restrictions JSONB NOT NULL,
    nutritional_goals JSONB NOT NULL,
    preferences JSONB NOT NULL,
    medical_considerations JSONB,
    growth_tracking JSONB,
    profile_version INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Comprehensive meal history with feedback and consumption tracking
CREATE TABLE meal_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID NOT NULL REFERENCES users(id),
    menu_item_id UUID NOT NULL REFERENCES menu_items(id),
    order_date DATE NOT NULL,
    consumption_date DATE,
    quantity INTEGER NOT NULL,
    portion_size JSONB NOT NULL,
    consumption_level INTEGER CHECK (consumption_level >= 0 AND consumption_level <= 100),
    satisfaction JSONB NOT NULL,
    feedback JSONB,
    photos TEXT[],
    nutritional_impact JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Favorite meals with reordering and customization support
CREATE TABLE favorite_meals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID NOT NULL REFERENCES users(id),
    menu_item_id UUID NOT NULL REFERENCES menu_items(id),
    customizations JSONB DEFAULT '[]',
    frequency INTEGER DEFAULT 1,
    last_ordered TIMESTAMP WITH TIME ZONE,
    average_rating DECIMAL(3,2),
    seasonal_availability JSONB,
    reorder_count INTEGER DEFAULT 0,
    shareable_with_family BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(child_id, menu_item_id)
);

-- Recurring order templates for automatic meal planning
CREATE TABLE recurring_order_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    parent_id UUID NOT NULL REFERENCES users(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    child_ids UUID[] NOT NULL,
    meal_pattern JSONB NOT NULL,
    scheduling_rules JSONB NOT NULL,
    budget_constraints JSONB,
    nutritional_targets JSONB,
    flexibility JSONB NOT NULL,
    is_active BOOLEAN DEFAULT true,
    performance JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Smart suggestions and recommendation tracking
CREATE TABLE recommendation_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    child_id UUID REFERENCES users(id),
    menu_item_id UUID NOT NULL REFERENCES menu_items(id),
    suggestion_type VARCHAR(50) NOT NULL,
    confidence_score DECIMAL(3,2),
    reasoning_factors JSONB,
    acceptance_status VARCHAR(20),
    feedback_rating INTEGER CHECK (feedback_rating >= 1 AND feedback_rating <= 5),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Family meal planning coordination
CREATE TABLE family_meal_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    family_id UUID NOT NULL,
    plan_period_start DATE NOT NULL,
    plan_period_end DATE NOT NULL,
    child_plans JSONB NOT NULL,
    shared_meals JSONB DEFAULT '[]',
    budget_allocation JSONB,
    nutritional_goals JSONB,
    family_preferences JSONB,
    conflicts JSONB DEFAULT '[]',
    resolutions JSONB DEFAULT '[]',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Performance indexes for preference operations
CREATE INDEX idx_child_profiles_parent ON child_dietary_profiles(parent_id);
CREATE INDEX idx_meal_history_child_date ON meal_history(child_id, consumption_date);
CREATE INDEX idx_favorite_meals_child ON favorite_meals(child_id);
CREATE INDEX idx_recurring_templates_parent_active ON recurring_order_templates(parent_id, is_active);
CREATE INDEX idx_recommendations_user_type ON recommendation_history(user_id, suggestion_type);
CREATE INDEX idx_family_plans_period ON family_meal_plans(plan_period_start, plan_period_end);
```

**API Endpoints** [Source: architecture.md#rest-api-specification]:

- **GET /children/{childId}/dietary-profile**: Get comprehensive child dietary profile
- **PUT /children/{childId}/dietary-profile**: Update child dietary preferences and restrictions
- **GET /children/{childId}/meal-history**: Get meal history with filtering and pagination
- **POST /children/{childId}/meal-feedback**: Submit meal feedback and rating
- **GET /children/{childId}/favorites**: Get favorite meals with reorder options
- **POST /children/{childId}/favorites**: Add meal to favorites with customizations
- **GET /parents/{parentId}/suggestions**: Get personalized meal suggestions
- **POST /parents/{parentId}/recurring-templates**: Create recurring order template
- **GET /parents/{parentId}/family-plan**: Get family meal planning interface
- **POST /parents/{parentId}/quick-actions**: Configure quick action preferences
- **GET /parents/{parentId}/preferences/learning**: Get preference learning insights

### File Structure Context

**Preference Management Components** [Source: architecture.md#unified-project-structure]:

```
apps/mobile/src/
├── screens/preferences/
│   ├── ChildProfileScreen.tsx        # Child dietary profile management
│   ├── MealHistoryScreen.tsx         # Meal history and feedback
│   ├── FavoritesScreen.tsx           # Favorite meals management
│   ├── RecurringOrdersScreen.tsx     # Recurring order templates
│   ├── FamilyPlanningScreen.tsx      # Family meal coordination
│   └── QuickActionsScreen.tsx        # Quick action configuration
├── components/preferences/
│   ├── ChildProfileForm.tsx          # Dietary profile editing
│   ├── MealRatingCard.tsx            # Meal feedback and rating
│   ├── FavoriteMealCard.tsx          # Favorite meal display and reorder
│   ├── SuggestionCard.tsx            # Smart meal suggestions
│   ├── RecurringTemplate.tsx         # Template creation and management
│   ├── FamilyCalendar.tsx            # Family meal planning calendar
│   ├── QuickActionButton.tsx         # Quick action interface
│   └── PreferenceLearning.tsx        # Learning insights display
├── hooks/preferences/
│   ├── useChildProfile.tsx           # Child profile state management
│   ├── useMealHistory.tsx            # Meal history and feedback
│   ├── useFavorites.tsx              # Favorites management
│   ├── useSmartSuggestions.tsx       # Recommendation engine integration
│   ├── useRecurringOrders.tsx        # Template management
│   ├── useFamilyPlanning.tsx         # Family coordination
│   └── usePreferenceLearning.tsx     # Learning system integration
└── services/
    ├── preferenceService.ts          # Preference API calls
    ├── suggestionService.ts          # Smart suggestion engine
    ├── templateService.ts            # Recurring order management
    ├── familyPlanningService.ts      # Family coordination service
    └── learningService.ts            # Preference learning system
```

**Backend Integration** [Source: architecture.md#unified-project-structure]:

```
apps/api/src/
├── functions/preferences/
│   ├── getChildProfile.ts            # Child profile retrieval
│   ├── updateChildProfile.ts         # Profile updates and validation
│   ├── getMealHistory.ts             # History with analytics
│   ├── submitMealFeedback.ts         # Feedback processing
│   ├── manageFavorites.ts            # Favorites CRUD operations
│   ├── generateSuggestions.ts        # Smart recommendation engine
│   ├── manageTemplates.ts            # Recurring order templates
│   ├── coordinateFamilyPlan.ts       # Family meal planning
│   ├── configureQuickActions.ts      # Quick action setup
│   └── processLearning.ts            # Preference learning algorithms
├── services/
│   ├── childProfileService.ts        # Profile business logic
│   ├── feedbackService.ts            # Feedback processing and analysis
│   ├── recommendationService.ts      # ML-based suggestions
│   ├── templateService.ts            # Template optimization
│   ├── familyCoordinationService.ts  # Family planning algorithms
│   ├── quickActionService.ts         # Quick action optimization
│   └── learningService.ts            # Preference learning engine
└── repositories/
    ├── profileRepository.ts          # Child profile data access
    ├── historyRepository.ts          # Meal history storage
    ├── favoritesRepository.ts        # Favorites management
    ├── templateRepository.ts         # Template persistence
    └── learningRepository.ts         # Learning data storage
```

### Business Logic Requirements

**Preference Learning Intelligence**:

- Bayesian learning algorithms adapting to changing child preferences over time
- Collaborative filtering incorporating anonymous family data for improved recommendations
- Seasonal preference adaptation with climate and cultural event integration
- Growth stage consideration adjusting recommendations based on developmental nutrition needs

**Family Coordination Algorithms**:

- Conflict resolution algorithms balancing individual preferences with family constraints
- Budget optimization distributing meal costs across children while maintaining nutrition goals
- Sibling preference harmonization suggesting compromise meals and shared favorites
- Parent workload optimization minimizing decision fatigue through intelligent automation

**Quick Action Intelligence**:

- Context-aware quick actions adapting to time of day, day of week, and recent orders
- Emergency ordering with dietary safety prioritization and expedited delivery
- Voice command integration with natural language processing for hands-free ordering
- Gesture-based shortcuts with accessibility considerations for motor impairments

**Performance Optimization**:

- Real-time recommendation generation with sub-200ms response times
- Preference caching with intelligent invalidation based on behavior changes
- Offline preference management with optimistic updates and conflict resolution
- Scalable learning algorithms handling thousands of families without performance degradation

### Previous Story Dependencies

**Dependencies from Epic 1**:

- **Story 1.2**: Authentication system for secure preference storage and family coordination
- **Story 1.3**: User management for parent-child relationships and multi-child families
- **Story 1.4**: API Gateway for preference synchronization and real-time updates

**Dependencies from Epic 2**:

- **Story 2.1**: Product catalog for meal option availability and detailed information
- **Story 2.2**: Menu planning for seasonal availability and scheduling integration
- **Story 2.3**: Nutritional information for preference-based nutritional goal tracking

**Dependencies from Stories 3.1-3.2**:

- **Menu Discovery**: Integration with browsing for preference-based filtering
- **Shopping Cart**: Cart templates and recurring order integration

### Integration Points

**Menu Discovery Integration**:

- Preference-based filtering automatically applied during menu browsing
- Smart suggestions prominently displayed in menu interface
- Quick reorder functionality embedded in menu discovery workflow

**Shopping Cart Integration**:

- Automatic cart population from recurring templates and quick actions
- Preference validation during cart building with suggestion alternatives
- Family coordination features integrated with cart sharing and approval

**Order History Integration**:

- Seamless reordering from meal history with preference learning feedback
- Rating and feedback collection integrated with order completion workflow
- Consumption tracking coordination with RFID delivery verification

**Future Epic Integration**:

- Payment system integration for automatic recurring order processing
- RFID system integration for automated consumption tracking and feedback
- Analytics system for preference pattern analysis and family insights
- Notification system for suggestion alerts and recurring order reminders

## Testing

### Testing Standards

- **Location**: Preference tests in `apps/mobile/__tests__/screens/preferences/` and `apps/api/__tests__/functions/preferences/`
- **Frameworks**: Jest with React Native Testing Library, Supertest for API testing
- **Coverage**: 95% coverage for learning algorithms, 100% for child safety features
- **Performance Testing**: Load testing for recommendation generation and family coordination

### Specific Test Requirements

- **Unit Tests**: All preference hooks, learning algorithms, recommendation engine
- **Integration Tests**: Complete preference workflows, family coordination, template management
- **Performance Tests**: Recommendation speed, large dataset handling, real-time updates
- **Security Tests**: Child data protection, preference privacy, family data isolation
- **Accessibility Tests**: Voice commands, gesture support, screen reader compatibility

### Test Scenarios

1. **Profile Management**: Child profile creation, preference updates, growth tracking
2. **Meal History**: Feedback submission, rating collection, consumption tracking
3. **Favorites System**: Adding favorites, reordering, customization management
4. **Smart Suggestions**: Recommendation accuracy, seasonal adaptation, preference learning
5. **Recurring Templates**: Template creation, automatic scheduling, modification handling
6. **Family Coordination**: Multi-child planning, conflict resolution, budget management
7. **Quick Actions**: One-touch ordering, emergency meals, voice command integration
8. **Learning System**: Preference adaptation, behavior pattern recognition, explanation features

## Change Log

| Date       | Version | Description                                                             | Author             |
| ---------- | ------- | ----------------------------------------------------------------------- | ------------------ |
| 2025-08-02 | 1.0     | Initial story creation with comprehensive preference management context | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be populated during development_

### Debug Log References

_To be populated during development_

### Completion Notes List

_To be populated during development_

### File List

_To be populated during development_

## QA Results

_Results from QA Agent review will be populated here after story implementation_
