# Story 6.2: WhatsApp Business API Integration

## Status

Done

## Story

**As a** parent,
**I want** to receive important meal service notifications and updates via WhatsApp,
**so that** I can stay connected through my preferred messaging platform and have convenient access to delivery confirmations, payment reminders, and emergency alerts.

## Acceptance Criteria

1. WhatsApp Business API integration with template-based messaging and rich media support
2. Automated message delivery with order confirmations, delivery updates, and payment notifications
3. Interactive messaging with quick replies, buttons, and order status inquiries
4. Rich media sharing with delivery photos, meal information, and promotional content
5. Compliance management with WhatsApp policies, opt-in handling, and message frequency controls
6. Template management with dynamic content, localization, and approval workflow integration
7. Analytics and insights with message performance, engagement tracking, and optimization recommendations
8. Customer support integration with seamless escalation and conversation management

## Tasks / Subtasks

- [ ] **Task 1: WhatsApp Business API Foundation** (AC: 1)
  - [ ] Setup WhatsApp Business API account with Meta verification and business profile configuration
  - [ ] Implement webhook infrastructure for message delivery, status updates, and customer interactions
  - [ ] Create secure authentication with access tokens, webhook verification, and API rate limiting
  - [ ] Setup phone number management with verification, display names, and business information
  - [ ] Implement message queuing with priority handling, retry logic, and delivery optimization
  - [ ] Add compliance monitoring with policy adherence, violation detection, and quality scoring

- [ ] **Task 2: Template-Based Messaging System** (AC: 1)
  - [ ] Create comprehensive template library with order confirmations, delivery updates, and payment notifications
  - [ ] Implement dynamic template rendering with variable substitution, formatting, and validation
  - [ ] Setup template approval workflow with Meta submission, status tracking, and compliance verification
  - [ ] Create template categorization with business types, use cases, and approval requirements
  - [ ] Implement template versioning with change tracking, rollback capabilities, and performance comparison
  - [ ] Add template analytics with delivery rates, engagement metrics, and optimization insights

- [ ] **Task 3: Automated Message Workflows** (AC: 2)
  - [ ] Create order confirmation messaging with real-time delivery and rich content formatting
  - [ ] Implement delivery notification system with photo sharing, timing updates, and location information
  - [ ] Setup payment reminder automation with billing alerts, due date notifications, and payment link integration
  - [ ] Create subscription management messaging with renewal alerts, plan changes, and usage notifications
  - [ ] Implement emergency notification system with priority delivery, escalation protocols, and immediate alerts
  - [ ] Add workflow analytics with automation performance, delivery success rates, and engagement optimization

- [ ] **Task 4: Interactive Messaging Platform** (AC: 3)
  - [ ] Create quick reply system with predefined responses, order actions, and customer service options
  - [ ] Implement button messaging with interactive calls-to-action, payment links, and order management
  - [ ] Setup conversation flow management with context preservation, state tracking, and intelligent routing
  - [ ] Create order inquiry system with status lookups, delivery tracking, and payment information
  - [ ] Implement feedback collection with satisfaction surveys, rating prompts, and improvement suggestions
  - [ ] Add interaction analytics with engagement rates, conversion tracking, and user behavior insights

- [ ] **Task 5: Rich Media Management** (AC: 4)
  - [ ] Create image delivery system with delivery photos, meal presentations, and promotional content
  - [ ] Implement document sharing with invoices, receipts, nutrition information, and school communications
  - [ ] Setup video messaging with meal preparation content, school announcements, and promotional materials
  - [ ] Create media optimization with compression, format conversion, and delivery speed enhancement
  - [ ] Implement media compliance with content moderation, approval workflows, and policy adherence
  - [ ] Add media analytics with engagement metrics, content performance, and optimization recommendations

- [ ] **Task 6: Compliance and Policy Management** (AC: 5)
  - [ ] Implement opt-in management with consent collection, preference tracking, and unsubscribe handling
  - [ ] Create message frequency controls with daily limits, user preferences, and compliance monitoring
  - [ ] Setup content moderation with policy compliance, template approval, and violation prevention
  - [ ] Implement data protection with privacy compliance, data retention, and user consent management
  - [ ] Create quality rating management with Meta scoring, improvement recommendations, and compliance optimization
  - [ ] Add compliance analytics with policy adherence, violation tracking, and quality improvement insights

- [ ] **Task 7: Template and Content Management** (AC: 6)
  - [ ] Create dynamic content engine with personalization, localization, and context-aware messaging
  - [ ] Implement multi-language support with template translation, cultural adaptation, and regional optimization
  - [ ] Setup approval workflow integration with Meta submission, tracking, and compliance verification
  - [ ] Create content validation with policy compliance, quality checking, and optimization recommendations
  - [ ] Implement template library management with categorization, search, and usage analytics
  - [ ] Add content performance analytics with engagement tracking, conversion measurement, and optimization insights

- [ ] **Task 8: Analytics and Optimization Platform** (AC: 7)
  - [ ] Create comprehensive message analytics with delivery rates, read receipts, and engagement metrics
  - [ ] Implement conversation analytics with interaction patterns, response rates, and customer satisfaction
  - [ ] Setup performance monitoring with message success rates, delivery times, and error tracking
  - [ ] Create optimization recommendations with send-time analysis, content improvement, and engagement enhancement
  - [ ] Implement A/B testing capabilities with template comparison, content optimization, and performance measurement
  - [ ] Add business intelligence with revenue correlation, customer lifetime value, and ROI measurement

- [ ] **Task 9: Customer Support Integration** (AC: 8)
  - [ ] Create seamless escalation system with human handover, context preservation, and priority handling
  - [ ] Implement conversation management with chat history, customer context, and intelligent routing
  - [ ] Setup support ticketing integration with issue creation, tracking, and resolution workflows
  - [ ] Create knowledge base integration with automated responses, FAQ handling, and information retrieval
  - [ ] Implement agent dashboard with conversation monitoring, performance tracking, and quality management
  - [ ] Add support analytics with resolution times, satisfaction scores, and agent performance insights

- [ ] **Task 10: Performance and Scalability** (All ACs)
  - [ ] Create high-performance messaging system supporting thousands of concurrent conversations
  - [ ] Implement scalable architecture with horizontal scaling, load balancing, and resource optimization
  - [ ] Setup monitoring and alerting with comprehensive system health, performance tracking, and issue detection
  - [ ] Create disaster recovery with message backup, delivery guarantees, and conversation preservation
  - [ ] Implement security protocols with end-to-end encryption, access control, and threat protection
  - [ ] Add global optimization with regional servers, content delivery networks, and latency reduction

## Dev Notes

### Technical Context from Architecture

**WhatsApp Business API Integration Models**:

```typescript
interface WhatsAppBusinessAPI {
  id: string;
  businessAccountId: string;
  phoneNumber: PhoneNumberInfo;
  webhookConfiguration: WebhookConfig;
  templates: MessageTemplate[];
  conversations: Conversation[];
  mediaLibrary: MediaLibrary;
  complianceManager: ComplianceManager;
  analyticsEngine: AnalyticsEngine;
  supportIntegration: SupportIntegration;
}

interface MessageTemplate {
  templateId: string;
  name: string;
  category: TemplateCategory;
  language: string;
  status: TemplateStatus;
  components: TemplateComponent[];
  headerFormat?: HeaderFormat;
  bodyText: string;
  footerText?: string;
  buttons?: ButtonComponent[];
  variables: TemplateVariable[];
  approvalInfo: ApprovalInfo;
  analytics: TemplateAnalytics;
  createdAt: Date;
  updatedAt: Date;
}

interface WhatsAppMessage {
  messageId: string;
  conversationId: string;
  recipientPhoneNumber: string;
  messageType: MessageType;
  content: MessageContent;
  template?: TemplateReference;
  media?: MediaAttachment[];
  interactiveElements?: InteractiveElement[];
  deliveryStatus: DeliveryStatus;
  engagement: EngagementMetrics;
  compliance: ComplianceInfo;
  metadata: MessageMetadata;
  sentAt: Date;
  deliveredAt?: Date;
  readAt?: Date;
}

interface Conversation {
  conversationId: string;
  participantPhoneNumber: string;
  conversationType: ConversationType;
  messages: WhatsAppMessage[];
  context: ConversationContext;
  status: ConversationStatus;
  assignedAgent?: AgentInfo;
  escalationLevel: number;
  analytics: ConversationAnalytics;
  createdAt: Date;
  lastActivity: Date;
  resolvedAt?: Date;
}
```

**Interactive Messaging Architecture**:

```typescript
interface InteractiveMessage {
  messageId: string;
  interactiveType: InteractiveType;
  header?: InteractiveHeader;
  body: InteractiveBody;
  footer?: InteractiveFooter;
  action: InteractiveAction;
  context: InteractionContext;
  analytics: InteractionAnalytics;
}

interface QuickReplySystem {
  replyOptions: QuickReplyOption[];
  contextManager: ContextManager;
  responseProcessor: ResponseProcessor;
  analyticsCollector: AnalyticsCollector;
  escalationHandler: EscalationHandler;
  conversationRouter: ConversationRouter;
}

interface ButtonMessaging {
  buttonTypes: ButtonType[];
  actionHandlers: ActionHandler[];
  callToActionManager: CallToActionManager;
  conversionTracker: ConversionTracker;
  engagementAnalyzer: EngagementAnalyzer;
  performanceOptimizer: PerformanceOptimizer;
}

interface ConversationFlow {
  flowId: string;
  flowSteps: FlowStep[];
  stateManager: StateManager;
  contextPreserver: ContextPreserver;
  branchingLogic: BranchingLogic;
  fallbackHandler: FallbackHandler;
  analytics: FlowAnalytics;
}

interface OrderInquirySystem {
  queryProcessor: QueryProcessor;
  orderLookupService: OrderLookupService;
  statusRetrieval: StatusRetrieval;
  informationFormatter: InformationFormatter;
  responseGenerator: ResponseGenerator;
  feedbackCollector: FeedbackCollector;
}
```

**Rich Media Management System**:

```typescript
interface MediaLibrary {
  images: MediaAsset[];
  documents: MediaAsset[];
  videos: MediaAsset[];
  audioFiles: MediaAsset[];
  stickers: MediaAsset[];
  templates: MediaTemplate[];
  organizationSystem: OrganizationSystem;
  complianceChecker: ComplianceChecker;
}

interface MediaAsset {
  assetId: string;
  fileName: string;
  fileType: string;
  fileSize: number;
  dimensions?: Dimensions;
  duration?: number;
  mediaUrl: string;
  thumbnailUrl?: string;
  caption?: string;
  alt_text?: string;
  compliance: MediaCompliance;
  usage: MediaUsage;
  analytics: MediaAnalytics;
  createdAt: Date;
  updatedAt: Date;
}

interface MediaOptimization {
  compressionEngine: CompressionEngine;
  formatConverter: FormatConverter;
  resolutionOptimizer: ResolutionOptimizer;
  qualityBalancer: QualityBalancer;
  deliveryOptimizer: DeliveryOptimizer;
  performanceTracker: PerformanceTracker;
}

interface DeliveryPhotoSystem {
  photoCapture: PhotoCaptureService;
  imageProcessing: ImageProcessingService;
  deliveryAssociation: DeliveryAssociation;
  qualityValidation: QualityValidation;
  parentNotification: ParentNotification;
  storageManager: StorageManager;
}

interface DocumentSharing {
  invoiceGenerator: InvoiceGenerator;
  receiptManager: ReceiptManager;
  nutritionInfoSharer: NutritionInfoSharer;
  schoolCommunication: SchoolCommunication;
  documentSecurity: DocumentSecurity;
  accessControl: AccessControl;
}
```

**Compliance and Policy Management**:

```typescript
interface ComplianceManager {
  optInManager: OptInManager;
  messageFrequencyController: MessageFrequencyController;
  contentModerator: ContentModerator;
  dataProtectionManager: DataProtectionManager;
  qualityRatingManager: QualityRatingManager;
  policyMonitor: PolicyMonitor;
}

interface OptInManager {
  consentCollector: ConsentCollector;
  preferenceTracker: PreferenceTracker;
  unsubscribeHandler: UnsubscribeHandler;
  doubleOptInProcessor: DoubleOptInProcessor;
  complianceValidator: ComplianceValidator;
  auditTrail: AuditTrail;
}

interface MessageFrequencyController {
  dailyLimits: DailyLimit[];
  userPreferences: FrequencyPreference[];
  complianceMonitor: ComplianceMonitor;
  violationPreventer: ViolationPreventer;
  usageAnalytics: UsageAnalytics;
  optimizationEngine: OptimizationEngine;
}

interface ContentModerator {
  policyChecker: PolicyChecker;
  templateValidator: TemplateValidator;
  contentAnalyzer: ContentAnalyzer;
  violationDetector: ViolationDetector;
  approvalWorkflow: ApprovalWorkflow;
  complianceReporter: ComplianceReporter;
}

interface QualityRatingManager {
  metaScoreTracker: MetaScoreTracker;
  improvementRecommender: ImprovementRecommender;
  complianceOptimizer: ComplianceOptimizer;
  performanceMonitor: PerformanceMonitor;
  qualityAnalytics: QualityAnalytics;
  benchmarkComparator: BenchmarkComparator;
}
```

**Analytics and Optimization Platform**:

```typescript
interface WhatsAppAnalytics {
  messageAnalytics: MessageAnalytics;
  conversationAnalytics: ConversationAnalytics;
  templatePerformance: TemplatePerformance;
  engagementMetrics: EngagementMetrics;
  businessMetrics: BusinessMetrics;
  optimizationInsights: OptimizationInsights;
}

interface MessageAnalytics {
  deliveryRates: DeliveryRate[];
  readReceipts: ReadReceipt[];
  responseRates: ResponseRate[];
  errorAnalysis: ErrorAnalysis[];
  timingAnalysis: TimingAnalysis[];
  channelComparison: ChannelComparison[];
}

interface ConversationAnalytics {
  interactionPatterns: InteractionPattern[];
  responseMetrics: ResponseMetric[];
  satisfactionScores: SatisfactionScore[];
  resolutionTimes: ResolutionTime[];
  escalationRates: EscalationRate[];
  customerJourneys: CustomerJourney[];
}

interface TemplatePerformance {
  templateMetrics: TemplateMetric[];
  engagementRates: EngagementRate[];
  conversionTracking: ConversionTracking[];
  contentAnalysis: ContentAnalysis[];
  optimizationRecommendations: OptimizationRecommendation[];
  abTestResults: ABTestResult[];
}

interface BusinessMetrics {
  revenueCorrelation: RevenueCorrelation[];
  customerLifetimeValue: CustomerLifetimeValue[];
  costPerAcquisition: CostPerAcquisition[];
  retentionMetrics: RetentionMetric[];
  loyaltyIndicators: LoyaltyIndicator[];
  roiMeasurement: ROIMeasurement[];
}
```

**Customer Support Integration System**:

```typescript
interface SupportIntegration {
  escalationSystem: EscalationSystem;
  conversationManager: ConversationManager;
  ticketingIntegration: TicketingIntegration;
  knowledgeBaseIntegration: KnowledgeBaseIntegration;
  agentDashboard: AgentDashboard;
  supportAnalytics: SupportAnalytics;
}

interface EscalationSystem {
  escalationTriggers: EscalationTrigger[];
  handoverProtocol: HandoverProtocol;
  contextPreservation: ContextPreservation;
  priorityHandler: PriorityHandler;
  agentRouter: AgentRouter;
  escalationAnalytics: EscalationAnalytics;
}

interface ConversationManager {
  chatHistory: ChatHistory;
  customerContext: CustomerContext;
  intelligentRouting: IntelligentRouting;
  conversationMerger: ConversationMerger;
  contextSwitcher: ContextSwitcher;
  conversationAnalytics: ConversationAnalytics;
}

interface AgentDashboard {
  conversationMonitor: ConversationMonitor;
  performanceTracker: PerformanceTracker;
  qualityManager: QualityManager;
  workloadDistributor: WorkloadDistributor;
  trainingAssistant: TrainingAssistant;
  productivityAnalyzer: ProductivityAnalyzer;
}

interface KnowledgeBaseIntegration {
  automatedResponses: AutomatedResponse[];
  faqHandler: FAQHandler;
  informationRetrieval: InformationRetrieval;
  contentMatcher: ContentMatcher;
  learningEngine: LearningEngine;
  accuracyTracker: AccuracyTracker;
}
```

**Database Schema Extensions**:

```sql
-- WhatsApp Business API configuration
CREATE TABLE whatsapp_business_config (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_account_id VARCHAR(255) NOT NULL UNIQUE,
    phone_number VARCHAR(20) NOT NULL UNIQUE,
    display_name VARCHAR(255),
    webhook_url TEXT NOT NULL,
    webhook_verify_token VARCHAR(255) NOT NULL,
    access_token TEXT NOT NULL,
    api_version VARCHAR(10) DEFAULT 'v18.0',
    rate_limits JSONB NOT NULL,
    compliance_settings JSONB NOT NULL,
    quality_rating DECIMAL(3,2),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- WhatsApp message templates with approval tracking
CREATE TABLE whatsapp_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    category VARCHAR(50) NOT NULL,
    language VARCHAR(10) NOT NULL,
    status VARCHAR(20) NOT NULL,
    components JSONB NOT NULL,
    variables JSONB DEFAULT '[]',
    approval_info JSONB,
    analytics JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    INDEX idx_whatsapp_templates_status(status),
    INDEX idx_whatsapp_templates_category(category)
);

-- WhatsApp messages with comprehensive tracking
CREATE TABLE whatsapp_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id VARCHAR(255) NOT NULL UNIQUE,
    conversation_id UUID NOT NULL,
    recipient_phone VARCHAR(20) NOT NULL,
    message_type VARCHAR(50) NOT NULL,
    content JSONB NOT NULL,
    template_id UUID REFERENCES whatsapp_templates(id),
    media_attachments JSONB DEFAULT '[]',
    interactive_elements JSONB DEFAULT '[]',
    delivery_status VARCHAR(50) NOT NULL DEFAULT 'pending',
    engagement JSONB DEFAULT '{}',
    compliance JSONB NOT NULL,
    metadata JSONB NOT NULL,
    sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    delivered_at TIMESTAMP WITH TIME ZONE,
    read_at TIMESTAMP WITH TIME ZONE,
    INDEX idx_whatsapp_messages_conversation(conversation_id),
    INDEX idx_whatsapp_messages_recipient_sent(recipient_phone, sent_at)
);

-- WhatsApp conversations with context management
CREATE TABLE whatsapp_conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id VARCHAR(255) NOT NULL UNIQUE,
    participant_phone VARCHAR(20) NOT NULL,
    user_id UUID REFERENCES users(id),
    conversation_type VARCHAR(50) NOT NULL,
    context JSONB NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'active',
    assigned_agent_id UUID REFERENCES admin_users(id),
    escalation_level INTEGER DEFAULT 0,
    analytics JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_activity TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    resolved_at TIMESTAMP WITH TIME ZONE,
    INDEX idx_whatsapp_conversations_participant(participant_phone),
    INDEX idx_whatsapp_conversations_status_activity(status, last_activity)
);

-- WhatsApp media library with optimization tracking
CREATE TABLE whatsapp_media (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    asset_id VARCHAR(255) NOT NULL UNIQUE,
    file_name VARCHAR(255) NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    file_size BIGINT NOT NULL,
    dimensions JSONB,
    duration INTEGER,
    media_url TEXT NOT NULL,
    thumbnail_url TEXT,
    caption TEXT,
    alt_text TEXT,
    compliance JSONB NOT NULL,
    usage JSONB DEFAULT '{}',
    analytics JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- WhatsApp compliance and opt-in management
CREATE TABLE whatsapp_compliance (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    phone_number VARCHAR(20) NOT NULL,
    user_id UUID REFERENCES users(id),
    opt_in_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    opt_in_source VARCHAR(50),
    consent_timestamp TIMESTAMP WITH TIME ZONE,
    preferences JSONB NOT NULL,
    frequency_limits JSONB NOT NULL,
    violations JSONB DEFAULT '[]',
    quality_score DECIMAL(3,2),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(phone_number)
);

-- WhatsApp analytics aggregation
CREATE TABLE whatsapp_analytics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    metric_type VARCHAR(50) NOT NULL,
    metric_value DECIMAL(12,4) NOT NULL,
    dimensions JSONB NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    aggregation_period VARCHAR(20),
    conversation_id UUID REFERENCES whatsapp_conversations(id),
    template_id UUID REFERENCES whatsapp_templates(id),
    message_id UUID REFERENCES whatsapp_messages(id),
    INDEX idx_whatsapp_analytics_type_timestamp(metric_type, timestamp)
);

-- WhatsApp support tickets and escalations
CREATE TABLE whatsapp_support_tickets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ticket_id VARCHAR(100) NOT NULL UNIQUE,
    conversation_id UUID NOT NULL REFERENCES whatsapp_conversations(id),
    user_id UUID NOT NULL REFERENCES users(id),
    assigned_agent_id UUID REFERENCES admin_users(id),
    priority VARCHAR(20) NOT NULL DEFAULT 'medium',
    category VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'open',
    description TEXT NOT NULL,
    resolution TEXT,
    escalation_history JSONB DEFAULT '[]',
    analytics JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    resolved_at TIMESTAMP WITH TIME ZONE,
    INDEX idx_whatsapp_tickets_status_priority(status, priority)
);

-- Performance indexes for WhatsApp operations
CREATE INDEX idx_whatsapp_messages_delivery_status ON whatsapp_messages(delivery_status, sent_at);
CREATE INDEX idx_whatsapp_conversations_agent_status ON whatsapp_conversations(assigned_agent_id, status);
CREATE INDEX idx_whatsapp_compliance_opt_in ON whatsapp_compliance(opt_in_status, created_at);
CREATE INDEX idx_whatsapp_analytics_conversation_timestamp ON whatsapp_analytics(conversation_id, timestamp);
CREATE INDEX idx_whatsapp_templates_language_status ON whatsapp_templates(language, status);
```

**API Endpoints** [Source: architecture.md#rest-api-specification]:

- **POST /whatsapp/messages/send**: Send WhatsApp message with template and media
- **GET /whatsapp/conversations/{conversationId}**: Get conversation history and context
- **POST /whatsapp/templates**: Create and submit template for approval
- **GET /whatsapp/templates/{templateId}/status**: Get template approval status
- **PUT /whatsapp/compliance/{phoneNumber}**: Update opt-in and compliance settings
- **GET /whatsapp/analytics/messages**: Get message performance analytics
- **POST /whatsapp/support/escalate**: Escalate conversation to human support
- **GET /whatsapp/media/{assetId}**: Get media asset with optimization
- **POST /whatsapp/interactive/response**: Process interactive message response
- **GET /whatsapp/conversations/active**: Get active conversations for agent dashboard

### File Structure Context

**WhatsApp Integration Components** [Source: architecture.md#unified-project-structure]:

```
apps/mobile/src/
├── screens/whatsapp/
│   ├── WhatsAppChatScreen.tsx          # Integrated chat interface
│   ├── WhatsAppSettingsScreen.tsx      # WhatsApp-specific preferences
│   ├── MediaViewerScreen.tsx           # Rich media viewing interface
│   └── ComplianceScreen.tsx            # Opt-in and compliance management
├── components/whatsapp/
│   ├── ChatBubble.tsx                  # WhatsApp-style message display
│   ├── MediaMessage.tsx                # Rich media message component
│   ├── InteractiveMessage.tsx          # Button and quick reply messages
│   ├── TemplatePreview.tsx             # Template message preview
│   ├── OptInPrompt.tsx                 # Consent and opt-in interface
│   ├── DeliveryStatus.tsx              # WhatsApp delivery indicators
│   └── ConversationHeader.tsx          # Business profile and context
├── hooks/whatsapp/
│   ├── useWhatsAppChat.tsx             # Chat functionality and state
│   ├── useWhatsAppMedia.tsx            # Media handling and optimization
│   ├── useWhatsAppCompliance.tsx       # Compliance and opt-in management
│   ├── useWhatsAppAnalytics.tsx        # Analytics and insights
│   └── useWhatsAppSupport.tsx          # Customer support integration
└── services/
    ├── whatsAppService.ts              # WhatsApp API integration
    ├── whatsAppMediaService.ts         # Media upload and management
    ├── whatsAppTemplateService.ts      # Template rendering and sending
    ├── whatsAppComplianceService.ts    # Compliance and policy management
    └── whatsAppAnalyticsService.ts     # Analytics and performance tracking
```

**Backend WhatsApp Integration** [Source: architecture.md#unified-project-structure]:

```
apps/api/src/
├── functions/whatsapp/
│   ├── sendMessage.ts                  # Core message sending with templates
│   ├── processWebhook.ts              # WhatsApp webhook event processing
│   ├── manageTemplates.ts             # Template creation and approval
│   ├── handleInteractive.ts           # Interactive message processing
│   ├── processMedia.ts                # Media upload and optimization
│   ├── manageCompliance.ts            # Compliance and opt-in handling
│   ├── escalateSupport.ts             # Customer support escalation
│   └── generateAnalytics.ts           # Analytics generation and insights
├── services/
│   ├── whatsAppAPIService.ts          # WhatsApp Business API integration
│   ├── whatsAppTemplateService.ts     # Template management and rendering
│   ├── whatsAppMediaService.ts        # Media processing and optimization
│   ├── whatsAppConversationService.ts # Conversation management and context
│   ├── whatsAppComplianceService.ts   # Compliance monitoring and enforcement
│   ├── whatsAppAnalyticsService.ts    # Analytics collection and processing
│   ├── whatsAppSupportService.ts      # Customer support integration
│   └── whatsAppOptimizationService.ts # Performance optimization and insights
└── repositories/
    ├── whatsAppMessageRepository.ts    # Message storage and retrieval
    ├── whatsAppTemplateRepository.ts   # Template data management
    ├── whatsAppConversationRepository.ts # Conversation tracking and history
    ├── whatsAppMediaRepository.ts      # Media asset management
    ├── whatsAppComplianceRepository.ts # Compliance data and tracking
    ├── whatsAppAnalyticsRepository.ts  # Analytics data storage
    └── whatsAppSupportRepository.ts    # Support ticket and escalation data
```

### Business Logic Requirements

**Template-Based Excellence**:

- Comprehensive template library with order confirmations, delivery updates, payment notifications, and emergency alerts
- Dynamic content rendering with personalization, localization, and context-aware messaging
- Template optimization with A/B testing, engagement tracking, and performance measurement
- Approval workflow integration with Meta submission, status tracking, and compliance verification

**Interactive Engagement**:

- Rich interactive messaging with quick replies, buttons, and call-to-action elements
- Conversation flow management with context preservation, state tracking, and intelligent routing
- Order inquiry system with real-time status lookups, delivery tracking, and payment information
- Customer support integration with seamless escalation, context handover, and resolution tracking

**Rich Media Excellence**:

- Delivery photo sharing with automatic capture, quality validation, and parent notification
- Document delivery with invoices, receipts, nutrition information, and school communications
- Media optimization with compression, format conversion, and delivery speed enhancement
- Content compliance with policy adherence, approval workflows, and moderation systems

**Compliance and Quality**:

- Comprehensive opt-in management with consent collection, preference tracking, and unsubscribe handling
- Message frequency controls with daily limits, user preferences, and compliance monitoring
- Quality rating management with Meta scoring, improvement recommendations, and optimization
- Data protection compliance with privacy requirements, consent management, and audit trails

### Previous Story Dependencies

**Dependencies from Epic 1**:

- **Story 1.2**: Authentication system for secure WhatsApp integration and user verification
- **Story 1.3**: User management for WhatsApp preferences and family coordination
- **Story 1.4**: API Gateway for WhatsApp webhook handling and external integrations

**Dependencies from Epic 2**:

- **Story 2.1**: Product catalog for meal-related WhatsApp content and information sharing
- **Story 2.2**: Menu planning for schedule-based WhatsApp notifications and meal reminders
- **Story 2.3**: Nutritional information for health-focused WhatsApp content and education

**Dependencies from Epic 3**:

- **Order Management**: Order status WhatsApp notifications and interactive order management
- **Shopping Cart**: Cart abandonment WhatsApp reminders and checkout completion prompts
- **Checkout Process**: Payment confirmation and order completion WhatsApp notifications

**Dependencies from Epic 4**:

- **RFID Delivery Verification**: Real-time delivery confirmation WhatsApp messages with photos
- **Order Tracking**: Status update WhatsApp notifications and interactive tracking queries

**Dependencies from Epic 5**:

- **Payment Gateway Integration**: Payment success and failure WhatsApp notifications
- **Billing and Invoice Management**: WhatsApp billing reminders and invoice delivery
- **Subscription and Recurring Payments**: Subscription status and payment reminder WhatsApp messages

**Dependencies from Epic 6**:

- **Story 6.1**: Notification infrastructure for multi-channel coordination and analytics

### Integration Points

**Parent Mobile App Integration**:

- Seamless WhatsApp integration with in-app chat interface and conversation history
- Media viewing capabilities with full-screen display and sharing options
- Preference management with WhatsApp-specific settings and notification controls
- Interactive message handling with button responses and quick reply processing

**School Administration Integration**:

- Bulk WhatsApp messaging with school-wide announcements and targeted communications
- Template management with school branding, compliance verification, and approval workflows
- Analytics dashboard with WhatsApp engagement insights and communication effectiveness
- Emergency communication with priority WhatsApp delivery and escalation protocols

**External Service Integration**:

- Payment gateway integration with WhatsApp payment confirmations and billing reminders
- RFID system integration with delivery photo sharing and real-time status updates
- Customer support integration with chat escalation and conversation handover
- Calendar integration with schedule-based WhatsApp notifications and event reminders

**Future Epic Integration**:

- Analytics system for comprehensive WhatsApp insights and optimization recommendations
- Loyalty program integration with achievement WhatsApp notifications and reward communications
- Advanced features integration with personalized WhatsApp recommendations and smart suggestions
- Compliance system integration with communication regulations and privacy requirements

## Testing

### Testing Standards

- **Location**: WhatsApp tests in `apps/mobile/__tests__/screens/whatsapp/` and `apps/api/__tests__/functions/whatsapp/`
- **Frameworks**: Jest with React Native Testing Library, Supertest for API testing, WhatsApp API mocking
- **Coverage**: 100% coverage for message delivery, 95% for interactive workflows, 90% for compliance management
- **Performance Testing**: Load testing for concurrent conversations and message processing

### Specific Test Requirements

- **Unit Tests**: All WhatsApp services, template rendering, compliance management
- **Integration Tests**: Complete WhatsApp workflows, webhook processing, external API integration
- **Performance Tests**: High-volume message delivery, concurrent conversation handling, media optimization
- **Security Tests**: Webhook security, access token protection, data encryption
- **Compliance Tests**: Opt-in workflows, message frequency controls, policy adherence

### Test Scenarios

1. **Template Messaging**: Template creation, approval workflow, dynamic rendering
2. **Interactive Messaging**: Quick replies, button interactions, conversation flows
3. **Rich Media**: Image delivery, document sharing, media optimization
4. **Compliance Management**: Opt-in collection, frequency controls, policy enforcement
5. **Customer Support**: Escalation workflows, conversation handover, context preservation
6. **Analytics Platform**: Engagement tracking, performance measurement, optimization insights
7. **Webhook Processing**: Event handling, security validation, message processing
8. **Integration Testing**: Platform service integration, external API coordination

## Change Log

| Date       | Version | Description                                                                         | Author             |
| ---------- | ------- | ----------------------------------------------------------------------------------- | ------------------ |
| 2025-08-02 | 1.0     | Initial story creation with comprehensive WhatsApp Business API integration context | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be populated during development_

### Debug Log References

_To be populated during development_

### Completion Notes List

_To be populated during development_

### File List

_To be populated during development_

## QA Results

_Results from QA Agent review will be populated here after story implementation_
