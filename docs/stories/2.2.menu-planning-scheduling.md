# Story 2.2: Menu Planning and Scheduling

## Status
Done

## Story

**As a** school administrator,
**I want** flexible menu planning and scheduling capabilities,
**so that** I can create daily and weekly menus that reflect our food service offerings and special events.

## Acceptance Criteria

1. Daily menu creation with date-specific product selections and availability windows
2. Weekly menu templates with recurring patterns and automatic scheduling
3. Special event menu support with custom descriptions and pricing
4. Menu approval workflow with draft, review, and published states
5. Menu versioning and change tracking with administrator attribution
6. Advanced scheduling with lead time requirements and preparation deadlines
7. Menu preview functionality showing parent-facing view before publication
8. Integration with inventory system to prevent overcommitment of unavailable items

## Tasks / Subtasks

- [ ] **Task 1: Daily Menu Creation System** (AC: 1)
  - [ ] Create DailyMenu model with date-specific product selections and time windows
  - [ ] Implement menu item selection interface with product catalog integration
  - [ ] Setup availability window configuration for breakfast, lunch, and snack periods
  - [ ] Create date-specific pricing and promotional override capabilities
  - [ ] Implement menu item quantity planning and capacity management
  - [ ] Add conflict resolution for overlapping menu items and time windows

- [ ] **Task 2: Weekly Menu Template System** (AC: 2)
  - [ ] Create WeeklyMenuTemplate model with recurring pattern support
  - [ ] Implement template creation with day-of-week specific menu configurations
  - [ ] Setup automatic scheduling engine with template application to future dates
  - [ ] Create template versioning and seasonal template management
  - [ ] Implement template inheritance and customization for special periods
  - [ ] Add template analytics and performance tracking for optimization

- [ ] **Task 3: Special Event Menu Support** (AC: 3)
  - [ ] Create SpecialEventMenu model with custom descriptions and themed presentation
  - [ ] Implement event-specific pricing with special rates and package deals
  - [ ] Setup event calendar integration with school calendar and holiday management
  - [ ] Create custom menu branding and presentation for special occasions
  - [ ] Implement event notification system for parents and students
  - [ ] Add event analytics and feedback collection for future planning

- [ ] **Task 4: Menu Approval Workflow** (AC: 4)
  - [ ] Create menu state management (DRAFT, REVIEW, APPROVED, PUBLISHED, ARCHIVED)
  - [ ] Implement role-based approval workflow with administrator and nutritionist roles
  - [ ] Setup approval notification system with email and in-app notifications
  - [ ] Create approval comment system for feedback and revision requests
  - [ ] Implement bulk approval capabilities for weekly and monthly menu cycles
  - [ ] Add approval audit trail with timestamp and administrator attribution

- [ ] **Task 5: Menu Versioning and Change Tracking** (AC: 5)
  - [ ] Create comprehensive menu versioning system with change history
  - [ ] Implement change detection and diff visualization for menu modifications
  - [ ] Setup administrator attribution for all menu changes and approvals
  - [ ] Create rollback capabilities for reverting problematic menu changes
  - [ ] Implement change notification system for stakeholders and parents
  - [ ] Add change analytics and impact assessment for operational planning

- [ ] **Task 6: Advanced Scheduling System** (AC: 6)
  - [ ] Create lead time management with vendor preparation requirements
  - [ ] Implement preparation deadline calculation based on menu complexity
  - [ ] Setup automatic scheduling validation to prevent impossible timelines
  - [ ] Create vendor notification system for upcoming menu requirements
  - [ ] Implement capacity planning with concurrent menu and event management
  - [ ] Add scheduling optimization for efficient kitchen operations

- [ ] **Task 7: Menu Preview System** (AC: 7)
  - [ ] Create parent-facing menu preview with mobile and web responsive design
  - [ ] Implement real-time preview generation with current pricing and availability
  - [ ] Setup preview sharing capabilities for stakeholder review and feedback
  - [ ] Create preview comparison tools for before/after menu changes
  - [ ] Implement preview analytics for user engagement and preference tracking
  - [ ] Add accessibility features for preview content and navigation

- [ ] **Task 8: Inventory Integration System** (AC: 8)
  - [ ] Create real-time inventory checking during menu planning process
  - [ ] Implement overcommitment prevention with intelligent quantity management
  - [ ] Setup inventory forecasting based on planned menu and historical consumption
  - [ ] Create vendor coordination system for inventory alignment with menus
  - [ ] Implement automatic menu adjustment suggestions for inventory conflicts
  - [ ] Add inventory-menu optimization for cost efficiency and waste reduction

- [ ] **Task 9: Menu Management API and Integration** (All ACs)
  - [ ] Create comprehensive menu management REST API with full CRUD operations
  - [ ] Implement menu calendar API with date-range queries and filtering
  - [ ] Setup menu template API with creation, application, and management endpoints
  - [ ] Create menu approval API with workflow state management
  - [ ] Implement menu analytics API for performance tracking and insights
  - [ ] Add real-time menu updates with WebSocket integration for live changes

## Dev Notes

### Technical Context from Architecture

**Menu Planning Data Models**:
```typescript
interface DailyMenu {
  id: string;
  schoolId: string;
  date: Date;
  menuItems: MenuItemSelection[];
  availabilityWindows: AvailabilityWindow[];
  status: MenuStatus;
  specialEventInfo?: SpecialEventInfo;
  approvalWorkflow: ApprovalWorkflow;
  version: number;
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
}

interface MenuItemSelection {
  menuItemId: string;
  quantityPlanned: number;
  customPricing?: PricingOverride;
  availabilityWindow: TimeWindow;
  preparationRequirements: PreparationInfo;
}

interface WeeklyMenuTemplate {
  id: string;
  schoolId: string;
  name: string;
  description: string;
  isActive: boolean;
  weeklyPattern: DailyMenuPattern[];
  seasonalVariations: SeasonalVariation[];
  effectiveStartDate: Date;
  effectiveEndDate?: Date;
  createdBy: string;
  version: number;
}

interface DailyMenuPattern {
  dayOfWeek: number; // 0-6 (Sunday-Saturday)
  mealPeriods: MealPeriod[];
  isActive: boolean;
}

interface MealPeriod {
  name: string; // 'BREAKFAST', 'LUNCH', 'SNACK'
  timeWindow: TimeWindow;
  menuItems: string[]; // MenuItem IDs
  maxCapacity?: number;
}
```

**School Integration** [Source: architecture.md#data-models]:
```typescript
interface School {
  id: string;
  name: string;
  operatingHours: Schedule;
  configuration: SchoolConfig;
  // ... other properties
}

interface SchoolConfig {
  allowAdvanceOrdering: boolean;
  maxAdvanceDays: number;
  requireParentApproval: boolean;
  enableNutritionalTracking: boolean;
  customBranding?: BrandingConfig;
}

interface Schedule {
  monday: DaySchedule;
  tuesday: DaySchedule;
  wednesday: DaySchedule;
  thursday: DaySchedule;
  friday: DaySchedule;
  saturday?: DaySchedule;
  sunday?: DaySchedule;
}

interface DaySchedule {
  isOpen: boolean;
  openTime: string;
  closeTime: string;
  mealPeriods: MealPeriod[];
}
```

**API Endpoints** [Source: architecture.md#rest-api-specification]:
- **GET /schools/{schoolId}/menus**: Get school menu for specific date with query parameters
- **POST /schools/{schoolId}/menus**: Create new daily menu
- **PUT /schools/{schoolId}/menus/{date}**: Update daily menu
- **GET /schools/{schoolId}/menu-templates**: List weekly menu templates
- **POST /schools/{schoolId}/menu-templates**: Create weekly menu template
- **POST /schools/{schoolId}/menus/generate-from-template**: Generate menus from template
- **PUT /schools/{schoolId}/menus/{menuId}/approve**: Menu approval workflow
- **GET /schools/{schoolId}/menus/preview**: Parent-facing menu preview

**Database Schema Extensions**:
```sql
-- Daily menus with comprehensive planning data
CREATE TABLE daily_menus (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    school_id UUID NOT NULL REFERENCES schools(id),
    menu_date DATE NOT NULL,
    menu_items JSONB NOT NULL,
    availability_windows JSONB NOT NULL,
    status VARCHAR(20) DEFAULT 'DRAFT',
    special_event_info JSONB,
    approval_workflow JSONB,
    version INTEGER DEFAULT 1,
    created_by UUID NOT NULL REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(school_id, menu_date, version)
);

-- Weekly menu templates for recurring patterns
CREATE TABLE weekly_menu_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    school_id UUID NOT NULL REFERENCES schools(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    weekly_pattern JSONB NOT NULL,
    seasonal_variations JSONB DEFAULT '[]',
    effective_start_date DATE NOT NULL,
    effective_end_date DATE,
    created_by UUID NOT NULL REFERENCES users(id),
    version INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Menu approval workflow tracking
CREATE TABLE menu_approvals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    menu_id UUID NOT NULL REFERENCES daily_menus(id),
    approver_id UUID NOT NULL REFERENCES users(id),
    approval_status VARCHAR(20) NOT NULL,
    comments TEXT,
    approved_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Performance indexes for menu operations
CREATE INDEX idx_daily_menus_school_date ON daily_menus(school_id, menu_date);
CREATE INDEX idx_daily_menus_status ON daily_menus(status);
CREATE INDEX idx_daily_menus_created_by ON daily_menus(created_by);
CREATE INDEX idx_weekly_templates_school ON weekly_menu_templates(school_id);
CREATE INDEX idx_weekly_templates_active ON weekly_menu_templates(is_active);
CREATE INDEX idx_menu_approvals_menu_id ON menu_approvals(menu_id);
```

**Workflow States and Transitions**:
```typescript
enum MenuStatus {
  DRAFT = 'DRAFT',
  REVIEW = 'REVIEW',
  APPROVED = 'APPROVED', 
  PUBLISHED = 'PUBLISHED',
  ARCHIVED = 'ARCHIVED'
}

interface ApprovalWorkflow {
  currentStatus: MenuStatus;
  requiredApprovers: string[]; // User IDs of required approvers
  approvals: ApprovalRecord[];
  rejections: RejectionRecord[];
  pendingApproval: string[]; // User IDs of pending approvers
}

interface ApprovalRecord {
  approverId: string;
  approvedAt: Date;
  comments?: string;
}
```

### File Structure Context

**Menu Planning Files** [Source: architecture.md#unified-project-structure]:
```
apps/api/src/
├── functions/menu-planning/
│   ├── createDailyMenu.ts        # Daily menu creation
│   ├── updateDailyMenu.ts        # Daily menu updates
│   ├── getDailyMenus.ts          # Menu retrieval with date filtering
│   ├── createMenuTemplate.ts     # Weekly template creation
│   ├── applyMenuTemplate.ts      # Template application to dates
│   ├── approveMenu.ts            # Menu approval workflow
│   ├── previewMenu.ts            # Parent-facing preview generation
│   └── scheduleMenus.ts          # Advanced scheduling logic
├── services/
│   ├── menuPlanningService.ts    # Menu planning business logic
│   ├── templateService.ts        # Template management service
│   ├── approvalService.ts        # Approval workflow service
│   ├── schedulingService.ts      # Advanced scheduling service
│   └── previewService.ts         # Menu preview generation
├── repositories/
│   ├── dailyMenuRepository.ts    # Daily menu data access
│   ├── menuTemplateRepository.ts # Template data access
│   └── approvalRepository.ts     # Approval workflow data access
└── validation/
    ├── menuPlanningSchemas.ts    # Menu validation schemas
    └── templateSchemas.ts        # Template validation schemas
```

**Frontend Integration** [Source: architecture.md#frontend-architecture]:
```typescript
// Menu planning components for admin portal
src/components/domain/menu-planning/
├── MenuCalendar.tsx              # Calendar view for menu planning
├── DailyMenuEditor.tsx           # Daily menu creation/editing
├── MenuTemplateManager.tsx       # Weekly template management
├── MenuApprovalWorkflow.tsx      # Approval process interface
├── MenuPreview.tsx               # Parent-facing preview
├── InventoryIntegration.tsx      # Inventory checking integration
├── SpecialEventMenu.tsx          # Special event menu creation
└── MenuAnalytics.tsx             # Menu performance analytics
```

### Business Logic Requirements

**Menu Planning Workflow**:
1. **Planning Phase**: Administrators create daily menus or apply weekly templates
2. **Review Phase**: Nutritionists and senior administrators review menu content
3. **Approval Phase**: Required approvers validate menu before publication
4. **Publication Phase**: Menu becomes visible to parents for ordering
5. **Monitoring Phase**: Track performance and inventory alignment

**Template Management**:
- Seasonal template variations for different times of year
- Holiday and special event template overrides
- Template performance analytics for optimization
- Automatic template application with manual override capabilities

**Inventory Integration Logic**:
- Real-time inventory checking during menu planning
- Automatic warnings for insufficient inventory levels
- Vendor notification for upcoming inventory requirements
- Menu optimization suggestions based on inventory availability

**Special Event Handling**:
- Integration with school calendar for automatic event detection
- Custom pricing and presentation for special occasions
- Event-specific notification campaigns for parents
- Post-event feedback collection and analysis

### Previous Story Dependencies

**Dependencies from Epic 1**:
- **Story 1.1**: Database infrastructure and application foundation
- **Story 1.2**: Authentication system for administrator access control
- **Story 1.3**: User management for administrator roles and permissions
- **Story 1.4**: API Gateway for secure menu management endpoints

**Dependencies from Story 2.1**:
- **Product Catalog Foundation**: MenuItem models and product availability system
- **Inventory Integration**: Stock level tracking and reorder point management
- **Pricing System**: Base pricing and promotional pricing capabilities
- **Category Management**: Product organization for menu planning

### Integration Points

**School Operations Integration**:
- School operating hours determine menu availability windows
- School configuration affects advance ordering and approval requirements
- School calendar integration for holiday and event planning

**Vendor Coordination**:
- Vendor notification for upcoming menu requirements
- Vendor inventory system integration for capacity planning
- Vendor performance tracking based on menu delivery

**Parent Interface Integration**:
- Real-time menu preview for parent decision making
- Menu change notifications for parents with existing orders
- Dietary preference integration for personalized menu views

**Future Epic Integration**:
- Order management will reference published menus for availability validation
- Payment system will integrate with special event pricing
- RFID system will track delivery against published menu schedules
- Analytics will provide menu performance insights for optimization

## Testing

### Testing Standards
- **Location**: Menu planning tests in `apps/api/__tests__/functions/menu-planning/` and `apps/api/__tests__/services/`
- **Frameworks**: Jest for unit testing, Supertest for API integration testing
- **Coverage**: 90% coverage required for menu logic, 100% for approval workflows
- **Database Testing**: Transaction testing for complex menu operations and state changes

### Specific Test Requirements
- **Unit Tests**: All menu planning services, template logic, approval workflows
- **Integration Tests**: Complete menu creation workflows, template application, approval processes
- **Performance Tests**: Menu generation speed, template application efficiency, calendar queries
- **Security Tests**: Authorization checks for menu operations, approval workflow security
- **Business Logic Tests**: Inventory integration, scheduling logic, conflict resolution

### Test Scenarios
1. **Daily Menu Creation**: Menu item selection, availability windows, inventory checking
2. **Template Management**: Template creation, application, seasonal variations
3. **Approval Workflow**: Multi-stage approval, rejection handling, comment management
4. **Special Event Menus**: Custom pricing, themed presentation, notification delivery
5. **Scheduling Logic**: Lead time calculation, preparation deadlines, conflict resolution
6. **Preview Generation**: Parent-facing display, real-time updates, accessibility compliance
7. **Inventory Integration**: Stock checking, overcommitment prevention, vendor coordination
8. **Performance Testing**: Menu calendar queries, template application speed, bulk operations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-02 | 1.0 | Initial story creation with comprehensive menu planning context | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated during development*

### Debug Log References
*To be populated during development*

### Completion Notes List
*To be populated during development*

### File List
*To be populated during development*

## QA Results

*Results from QA Agent review will be populated here after story implementation*