# Story 3.2: Shopping Cart and Order Management

## Status

Done

## Story

**As a** parent,
**I want** streamlined shopping cart with intelligent scheduling options,
**so that** I can efficiently plan and order multiple meals while managing delivery preferences.

## Acceptance Criteria

1. Interactive shopping cart with drag-and-drop meal scheduling interface
2. Quantity management with portion size options and special instructions
3. Order timing selection with calendar view and delivery window preferences
4. Smart scheduling suggestions based on school calendar and previous ordering patterns
5. Order summary with total pricing, nutritional information, and delivery details
6. Save cart functionality for incomplete orders and quick reordering
7. Bulk ordering capabilities for weekly/monthly meal planning
8. Real-time pricing updates and discount application with clear breakdown

## Tasks / Subtasks

- [ ] **Task 1: Interactive Shopping Cart Interface** (AC: 1)
  - [ ] Create drag-and-drop shopping cart with meal scheduling calendar integration
  - [ ] Implement intuitive cart item management with swipe gestures and quick actions
  - [ ] Setup visual cart organization by date, meal type, and child preferences
  - [ ] Create responsive cart design optimized for mobile touch interactions
  - [ ] Implement cart state persistence across app sessions and device switching
  - [ ] Add cart sharing functionality for family coordination and approval workflows

- [ ] **Task 2: Quantity and Portion Management** (AC: 2)
  - [ ] Create portion size selection with age-appropriate serving recommendations
  - [ ] Implement quantity adjustments with nutritional impact calculations
  - [ ] Setup special instructions interface with predefined options and free text
  - [ ] Create dietary modification requests with allergen-safe alternatives
  - [ ] Implement serving size calculator based on child age, weight, and activity level
  - [ ] Add nutritional goal tracking with portion size impact visualization

- [ ] **Task 3: Order Timing and Scheduling** (AC: 3)
  - [ ] Create calendar-based order scheduling with school calendar integration
  - [ ] Implement delivery window selection with availability checking and conflicts
  - [ ] Setup recurring order scheduling with pattern recognition and suggestions
  - [ ] Create time zone management for families with multiple school schedules
  - [ ] Implement scheduling conflict resolution with alternative suggestions
  - [ ] Add emergency order scheduling with expedited delivery options

- [ ] **Task 4: Smart Scheduling Intelligence** (AC: 4)
  - [ ] Create ML-based scheduling suggestions using historical ordering patterns
  - [ ] Implement school calendar integration with holiday and event awareness
  - [ ] Setup weather-based meal suggestions and seasonal recommendation engine
  - [ ] Create family schedule optimization with multiple children coordination
  - [ ] Implement predictive ordering suggestions based on consumption patterns
  - [ ] Add scheduling analytics with optimization recommendations for parents

- [ ] **Task 5: Order Summary and Pricing** (AC: 5)
  - [ ] Create comprehensive order summary with itemized pricing and tax calculations
  - [ ] Implement real-time nutritional summary with daily value tracking
  - [ ] Setup delivery details display with timing, location, and special requirements
  - [ ] Create order validation with inventory checking and availability confirmation
  - [ ] Implement cost breakdown with discounts, taxes, and promotional pricing
  - [ ] Add nutritional goal progress tracking with order impact analysis

- [ ] **Task 6: Cart Persistence and Recovery** (AC: 6)
  - [ ] Create cart state management with automatic saving and recovery
  - [ ] Implement cart templates for quick reordering and family meal planning
  - [ ] Setup cart sharing between family members with permission management
  - [ ] Create cart versioning for tracking changes and restoring previous states
  - [ ] Implement offline cart functionality with synchronization when online
  - [ ] Add cart backup and restoration for device switching and app reinstallation

- [ ] **Task 7: Bulk Ordering System** (AC: 7)
  - [ ] Create weekly meal planning interface with template application
  - [ ] Implement monthly order management with subscription-like functionality
  - [ ] Setup bulk discount calculations with family and volume pricing
  - [ ] Create meal plan optimization with nutritional balance and variety
  - [ ] Implement bulk order modification with cascading change management
  - [ ] Add bulk order analytics with cost optimization and nutritional tracking

- [ ] **Task 8: Real-time Updates and Discounts** (AC: 8)
  - [ ] Create real-time pricing engine with dynamic updates and notifications
  - [ ] Implement discount application with eligibility checking and stacking rules
  - [ ] Setup promotional code system with validation and usage tracking
  - [ ] Create loyalty program integration with point accumulation and redemption
  - [ ] Implement flash sale notifications with time-limited discount applications
  - [ ] Add price comparison and savings tracking with historical analysis

- [ ] **Task 9: Cart Analytics and Optimization** (All ACs)
  - [ ] Create cart abandonment tracking with recovery email campaigns
  - [ ] Implement order pattern analysis for personalized recommendations
  - [ ] Setup cart performance metrics with conversion tracking and optimization
  - [ ] Create family spending analytics with budget management and alerts
  - [ ] Implement nutritional analysis across cart items with balance recommendations
  - [ ] Add cart optimization suggestions for cost savings and nutritional improvement

## Dev Notes

### Technical Context from Architecture

**Shopping Cart Data Models**:

```typescript
interface ShoppingCart {
  id: string;
  parentId: string;
  schoolId: string;
  cartItems: CartItem[];
  schedulingInfo: OrderScheduling;
  pricingSummary: PricingSummary;
  nutritionalSummary: NutritionalSummary;
  deliveryPreferences: DeliveryPreferences;
  status: CartStatus;
  createdAt: Date;
  updatedAt: Date;
  expiresAt: Date;
}

interface CartItem {
  id: string;
  menuItemId: string;
  childId: string;
  quantity: number;
  portionSize: PortionSize;
  scheduledDate: Date;
  mealPeriod: MealPeriod;
  specialInstructions: string;
  dietaryModifications: DietaryModification[];
  pricingInfo: CartItemPricing;
  nutritionalInfo: CartItemNutrition;
  availability: ItemAvailability;
}

interface OrderScheduling {
  orderType: 'single' | 'recurring' | 'bulk';
  scheduledDates: ScheduledMeal[];
  recurringPattern?: RecurringPattern;
  deliveryWindows: DeliveryWindow[];
  specialRequirements: SpecialRequirement[];
  conflictResolution: ConflictResolution[];
}

interface ScheduledMeal {
  date: Date;
  mealPeriod: MealPeriod;
  cartItemIds: string[];
  deliveryWindow: TimeWindow;
  preparationDeadline: Date;
  status: ScheduleStatus;
}
```

**Cart State Management** [Source: architecture.md#state-management]:

```typescript
interface CartState {
  currentCart: ShoppingCart | null;
  cartHistory: CartSnapshot[];
  templates: CartTemplate[];
  preferences: CartPreferences;
  analytics: CartAnalytics;
  syncStatus: SyncStatus;
}

interface CartPreferences {
  defaultPortionSizes: Record<string, PortionSize>; // childId -> portion
  preferredDeliveryWindows: TimeWindow[];
  notificationSettings: CartNotificationSettings;
  automaticSuggestions: boolean;
  bulkOrderingEnabled: boolean;
  familyCoordinationEnabled: boolean;
}

interface CartTemplate {
  id: string;
  name: string;
  description: string;
  cartItems: CartItem[];
  schedulingPattern: RecurringPattern;
  nutritionalGoals: NutritionalGoals;
  isActive: boolean;
  createdAt: Date;
}
```

**Pricing and Discount Integration** [Source: story 2.1]:

```typescript
interface PricingSummary {
  subtotal: number;
  discounts: AppliedDiscount[];
  taxes: TaxCalculation[];
  deliveryFees: DeliveryFee[];
  loyaltyDiscount: number;
  total: number;
  currency: string;
  priceBreakdown: PriceBreakdownItem[];
}

interface AppliedDiscount {
  id: string;
  type: DiscountType;
  name: string;
  description: string;
  amount: number;
  percentage?: number;
  conditions: DiscountCondition[];
  validUntil: Date;
  stackable: boolean;
}

interface CartItemPricing {
  basePrice: number;
  quantity: number;
  portionAdjustment: number;
  discounts: AppliedDiscount[];
  subtotal: number;
  priceHistory: PriceHistoryEntry[];
}
```

**Nutritional Integration** [Source: story 2.3]:

```typescript
interface NutritionalSummary {
  totalNutrition: NutritionalInfo;
  dailyValuePercentages: Record<string, number>;
  nutritionalGoals: NutritionalGoalProgress[];
  recommendations: NutritionalRecommendation[];
  allergenWarnings: AllergenWarning[];
  dietaryCompliance: DietaryComplianceCheck[];
}

interface CartItemNutrition {
  baseNutrition: NutritionalInfo;
  adjustedNutrition: NutritionalInfo; // Based on portion size
  allergenInfo: AllergenInfo;
  dietaryLabels: DietaryLabels;
  nutritionalScore: number;
  healthRating: HealthRating;
}
```

**Database Schema Extensions**:

```sql
-- Shopping cart storage with comprehensive state management
CREATE TABLE shopping_carts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    parent_id UUID NOT NULL REFERENCES users(id),
    school_id UUID NOT NULL REFERENCES schools(id),
    cart_data JSONB NOT NULL,
    scheduling_info JSONB NOT NULL,
    pricing_summary JSONB NOT NULL,
    nutritional_summary JSONB NOT NULL,
    delivery_preferences JSONB NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    expires_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Cart items with detailed scheduling and nutritional information
CREATE TABLE cart_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    cart_id UUID NOT NULL REFERENCES shopping_carts(id) ON DELETE CASCADE,
    menu_item_id UUID NOT NULL REFERENCES menu_items(id),
    child_id UUID NOT NULL REFERENCES users(id),
    quantity INTEGER NOT NULL DEFAULT 1,
    portion_size JSONB NOT NULL,
    scheduled_date DATE NOT NULL,
    meal_period VARCHAR(20) NOT NULL,
    special_instructions TEXT,
    dietary_modifications JSONB DEFAULT '[]',
    pricing_info JSONB NOT NULL,
    nutritional_info JSONB NOT NULL,
    availability_info JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Cart templates for recurring orders and meal planning
CREATE TABLE cart_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    parent_id UUID NOT NULL REFERENCES users(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    template_data JSONB NOT NULL,
    scheduling_pattern JSONB NOT NULL,
    nutritional_goals JSONB NOT NULL,
    is_active BOOLEAN DEFAULT true,
    usage_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Cart analytics and performance tracking
CREATE TABLE cart_analytics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    cart_id UUID NOT NULL REFERENCES shopping_carts(id),
    event_type VARCHAR(50) NOT NULL,
    event_data JSONB NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    session_id VARCHAR(255),
    user_agent TEXT
);

-- Performance indexes for cart operations
CREATE INDEX idx_shopping_carts_parent_status ON shopping_carts(parent_id, status);
CREATE INDEX idx_cart_items_cart_id ON cart_items(cart_id);
CREATE INDEX idx_cart_items_scheduled_date ON cart_items(scheduled_date);
CREATE INDEX idx_cart_templates_parent_active ON cart_templates(parent_id, is_active);
CREATE INDEX idx_cart_analytics_cart_event ON cart_analytics(cart_id, event_type);
```

**API Endpoints** [Source: architecture.md#rest-api-specification]:

- **GET /parents/{parentId}/cart**: Get current shopping cart with all items
- **POST /parents/{parentId}/cart/items**: Add item to shopping cart
- **PUT /cart-items/{itemId}**: Update cart item (quantity, scheduling, instructions)
- **DELETE /cart-items/{itemId}**: Remove item from cart
- **POST /parents/{parentId}/cart/schedule**: Update cart scheduling and delivery preferences
- **GET /parents/{parentId}/cart/pricing**: Get real-time pricing and discount information
- **POST /parents/{parentId}/cart/apply-discount**: Apply discount code or promotion
- **POST /parents/{parentId}/cart/templates**: Save cart as template for reuse
- **GET /parents/{parentId}/cart/templates**: Get saved cart templates
- **POST /parents/{parentId}/cart/bulk-order**: Create bulk order from cart template

### File Structure Context

**Shopping Cart Components** [Source: architecture.md#unified-project-structure]:

```
apps/mobile/src/
├── screens/cart/
│   ├── ShoppingCartScreen.tsx        # Main shopping cart interface
│   ├── CartSchedulingScreen.tsx      # Order scheduling and calendar
│   ├── CartSummaryScreen.tsx         # Order summary and pricing
│   ├── BulkOrderScreen.tsx           # Weekly/monthly order planning
│   └── CartTemplatesScreen.tsx       # Saved cart templates
├── components/cart/
│   ├── CartItemCard.tsx              # Individual cart item display
│   ├── CartScheduler.tsx             # Drag-and-drop scheduling interface
│   ├── QuantitySelector.tsx          # Portion size and quantity controls
│   ├── PricingSummary.tsx            # Real-time pricing display
│   ├── NutritionalSummary.tsx        # Cart nutritional analysis
│   ├── DiscountApplicator.tsx        # Discount code and promotion interface
│   ├── DeliveryPreferences.tsx       # Delivery timing and preferences
│   └── CartTemplate.tsx              # Template creation and management
├── hooks/cart/
│   ├── useShoppingCart.tsx           # Cart state management
│   ├── useCartScheduling.tsx         # Scheduling and calendar integration
│   ├── useCartPricing.tsx            # Real-time pricing and discounts
│   ├── useCartNutrition.tsx          # Nutritional analysis and tracking
│   └── useCartTemplates.tsx          # Template management and reuse
└── services/
    ├── cartService.ts                # Cart API calls and state sync
    ├── schedulingService.ts          # Order scheduling and calendar
    ├── pricingService.ts             # Pricing calculations and discounts
    └── templateService.ts            # Cart template management
```

**Backend Integration** [Source: architecture.md#unified-project-structure]:

```
apps/api/src/
├── functions/cart/
│   ├── getShoppingCart.ts            # Cart retrieval and state management
│   ├── addCartItem.ts                # Add items with validation
│   ├── updateCartItem.ts             # Update quantity, scheduling, instructions
│   ├── removeCartItem.ts             # Remove items and cleanup
│   ├── scheduleCart.ts               # Order scheduling and calendar integration
│   ├── calculatePricing.ts           # Real-time pricing and discount application
│   ├── applyDiscount.ts              # Discount validation and application
│   ├── createBulkOrder.ts            # Bulk order processing
│   └── manageTemplates.ts            # Cart template CRUD operations
├── services/
│   ├── cartService.ts                # Cart business logic and validation
│   ├── schedulingService.ts          # Order scheduling algorithms
│   ├── pricingService.ts             # Pricing calculations and tax
│   ├── discountService.ts            # Discount and promotion engine
│   ├── nutritionalService.ts         # Cart nutritional analysis
│   └── templateService.ts            # Template management and optimization
└── repositories/
    ├── cartRepository.ts             # Cart data access and persistence
    ├── cartItemRepository.ts         # Cart item CRUD operations
    └── templateRepository.ts         # Template storage and retrieval
```

### Business Logic Requirements

**Smart Scheduling Intelligence**:

- Machine learning-based pattern recognition for recurring meal preferences
- School calendar integration with automatic holiday and event detection
- Weather-based meal suggestions using local weather APIs and seasonal patterns
- Family schedule optimization considering multiple children and dietary requirements

**Real-time Pricing Engine**:

- Dynamic pricing updates with WebSocket connections for live price changes
- Complex discount stacking with business rule validation and conflict resolution
- Bulk pricing calculations with family and volume discount optimization
- Tax calculation integration with location-based tax rates and exemptions

**Cart Persistence and Recovery**:

- Multi-device cart synchronization with conflict resolution and user preference priority
- Offline-first architecture with local storage and optimistic updates
- Cart state versioning with rollback capabilities and change tracking
- Family sharing with permission management and approval workflows

**Nutritional Analysis Integration**:

- Real-time nutritional calculation across all cart items with portion adjustments
- Dietary goal tracking with progress visualization and recommendation engine
- Allergen safety validation with cross-contamination analysis and warnings
- Family nutritional optimization with balance recommendations and substitutions

### Previous Story Dependencies

**Dependencies from Epic 1**:

- **Story 1.2**: Authentication system for parent cart access and multi-child management
- **Story 1.3**: User management for parent-child relationships and family coordination
- **Story 1.4**: API Gateway for secure cart operations and real-time updates

**Dependencies from Epic 2**:

- **Story 2.1**: Product catalog for menu item details, pricing, and availability validation
- **Story 2.2**: Menu planning for scheduling integration and availability windows
- **Story 2.3**: Nutritional information for cart nutritional analysis and goal tracking

**Dependencies from Story 3.1**:

- **Menu Discovery**: Integration with menu browsing for seamless add-to-cart functionality
- **Search and Filtering**: Cart item search and dietary filter integration
- **Personalization**: Child profile integration for portion sizes and recommendations

### Integration Points

**Menu Browsing Integration**:

- Seamless add-to-cart from menu browsing with context preservation
- Quick reorder functionality from previous order history
- Personalized recommendations based on cart contents and child preferences

**Payment System Integration**:

- Real-time pricing updates with payment method validation
- Subscription and recurring payment integration for bulk orders
- Payment scheduling with automatic processing and failure handling

**School Calendar Integration**:

- Automatic scheduling validation against school operating hours
- Holiday and special event detection with menu availability updates
- Emergency ordering with expedited delivery and notification systems

**Future Epic Integration**:

- Order management system for cart checkout and order placement
- RFID delivery verification for cart-to-delivery tracking
- Analytics system for cart performance and user behavior insights
- Notification system for cart reminders and promotional updates

## Testing

### Testing Standards

- **Location**: Cart tests in `apps/mobile/__tests__/screens/cart/` and `apps/api/__tests__/functions/cart/`
- **Frameworks**: Jest with React Native Testing Library, Supertest for API testing
- **Coverage**: 95% coverage for cart logic, 100% for pricing and scheduling
- **Performance Testing**: Load testing for real-time updates and bulk operations

### Specific Test Requirements

- **Unit Tests**: All cart hooks, pricing calculations, scheduling algorithms
- **Integration Tests**: Complete cart workflows, payment integration, nutrition tracking
- **Performance Tests**: Real-time pricing updates, large cart handling, bulk operations
- **Security Tests**: Cart data protection, pricing validation, discount fraud prevention
- **Accessibility Tests**: Screen reader support, keyboard navigation, visual indicators

### Test Scenarios

1. **Cart Management**: Add/remove items, quantity updates, drag-and-drop scheduling
2. **Pricing Calculations**: Real-time updates, discount application, tax calculations
3. **Scheduling Intelligence**: Calendar integration, conflict resolution, pattern recognition
4. **Bulk Operations**: Weekly planning, template creation, bulk discount application
5. **Nutritional Analysis**: Real-time calculation, goal tracking, allergen validation
6. **Persistence**: Cart state saving, multi-device sync, offline functionality
7. **Family Coordination**: Cart sharing, approval workflows, permission management
8. **Performance**: Large cart loading, real-time updates, concurrent user handling

## Change Log

| Date       | Version | Description                                                     | Author             |
| ---------- | ------- | --------------------------------------------------------------- | ------------------ |
| 2025-08-02 | 1.0     | Initial story creation with comprehensive shopping cart context | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be populated during development_

### Debug Log References

_To be populated during development_

### Completion Notes List

_To be populated during development_

### File List

_To be populated during development_

## QA Results

_Results from QA Agent review will be populated here after story implementation_
