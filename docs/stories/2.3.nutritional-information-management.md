# Story 2.3: Nutritional Information Management

## Status
Done

## Story

**As a** parent,
**I want** detailed nutritional information for all menu items,
**so that** I can make informed decisions about my child's meals based on dietary needs and preferences.

## Acceptance Criteria

1. Comprehensive nutritional data entry including calories, macronutrients, vitamins, and minerals
2. Allergen information management with clear warnings and filtering capabilities
3. Dietary restriction labeling (vegetarian, vegan, gluten-free, halal, etc.)
4. Ingredient list management with detailed sourcing information where applicable
5. Nutritional summary calculations for complete meals and daily intake
6. Parent-facing nutritional dashboard with child-specific dietary tracking
7. Compliance with food labeling regulations and nutritional disclosure requirements
8. Integration with menu display showing nutritional highlights and warnings

## Tasks / Subtasks

- [ ] **Task 1: Enhanced Nutritional Data Model** (AC: 1)
  - [ ] Extend NutritionalInfo interface with comprehensive micronutrients (vitamins, minerals)
  - [ ] Create standardized nutritional database with USDA nutritional data integration
  - [ ] Implement nutritional data validation with acceptable ranges and verification
  - [ ] Setup nutritional calculation engine for recipe-based menu items
  - [ ] Create nutritional data import/export capabilities for vendor integration
  - [ ] Add nutritional data versioning and audit trail for compliance

- [ ] **Task 2: Allergen Management System** (AC: 2, 8)
  - [ ] Create comprehensive allergen database with standardized allergen categories
  - [ ] Implement allergen warning system with visual indicators and filtering
  - [ ] Setup cross-contamination tracking and kitchen safety protocols
  - [ ] Create allergen search and filtering capabilities for menu browsing
  - [ ] Implement allergen alert system for parents with child-specific allergies
  - [ ] Add allergen compliance reporting for food safety regulations

- [ ] **Task 3: Dietary Restriction Framework** (AC: 3)
  - [ ] Create dietary restriction labeling system (vegetarian, vegan, gluten-free, halal, kosher, etc.)
  - [ ] Implement dietary preference tracking for students and families
  - [ ] Setup automated dietary compliance checking for menu items
  - [ ] Create dietary restriction filtering for menu display and ordering
  - [ ] Implement cultural and religious dietary requirement support
  - [ ] Add dietary trend analytics for menu planning optimization

- [ ] **Task 4: Ingredient Management System** (AC: 4)
  - [ ] Create comprehensive ingredient database with sourcing information
  - [ ] Implement ingredient transparency features with supplier details
  - [ ] Setup organic, local, and sustainable ingredient tracking
  - [ ] Create ingredient substitution system for dietary accommodations
  - [ ] Implement ingredient cost tracking for pricing optimization
  - [ ] Add ingredient seasonality and availability tracking

- [ ] **Task 5: Nutritional Calculation Engine** (AC: 5)
  - [ ] Create meal composition calculator for complete nutritional profiles
  - [ ] Implement daily nutritional intake tracking and analysis
  - [ ] Setup nutritional goal setting and progress tracking for children
  - [ ] Create nutritional balance scoring system for meal optimization
  - [ ] Implement nutritional recommendation engine based on age and activity
  - [ ] Add nutritional deficit and excess warning system

- [ ] **Task 6: Parent Nutritional Dashboard** (AC: 6)
  - [ ] Create comprehensive nutritional dashboard with child-specific tracking
  - [ ] Implement nutritional history and trend visualization
  - [ ] Setup nutritional goal management and progress monitoring
  - [ ] Create personalized nutritional recommendations and insights
  - [ ] Implement nutritional alerts and notifications for parents
  - [ ] Add nutritional report generation and sharing capabilities

- [ ] **Task 7: Regulatory Compliance System** (AC: 7)
  - [ ] Implement Food Safety and Standards Authority of India (FSSAI) compliance
  - [ ] Create nutritional labeling compliance with Indian food regulations
  - [ ] Setup automated compliance checking and reporting
  - [ ] Implement nutritional disclosure requirements for school food programs
  - [ ] Create audit trail and documentation for regulatory inspections
  - [ ] Add compliance alert system for regulatory changes

- [ ] **Task 8: Menu Integration and Display** (AC: 8)
  - [ ] Integrate nutritional information with menu display system
  - [ ] Create nutritional highlights and warning display for menu items
  - [ ] Implement nutritional filtering and sorting for menu browsing
  - [ ] Setup nutritional comparison tools for meal selection
  - [ ] Create nutritional summary display for complete orders
  - [ ] Add nutritional accessibility features for visually impaired users

- [ ] **Task 9: Analytics and Reporting** (All ACs)
  - [ ] Create nutritional analytics dashboard for administrators
  - [ ] Implement nutritional trend analysis and reporting
  - [ ] Setup population-level nutritional tracking for school health programs
  - [ ] Create nutritional performance metrics and KPI tracking
  - [ ] Implement nutritional research data collection and analysis
  - [ ] Add nutritional benchmarking against national dietary guidelines

## Dev Notes

### Technical Context from Architecture

**Enhanced Nutritional Data Model** [Source: architecture.md#data-models]:
```typescript
interface NutritionalInfo {
  // Macronutrients (existing)
  calories: number;
  protein: number;
  carbohydrates: number;
  fat: number;
  fiber: number;
  sugar: number;
  sodium: number;
  servingSize: string;
  
  // Extended micronutrients
  vitamins: VitaminContent;
  minerals: MineralContent;
  fattyAcids: FattyAcidProfile;
  additionalNutrients: AdditionalNutrients;
}

interface VitaminContent {
  vitaminA: number; // IU
  vitaminC: number; // mg
  vitaminD: number; // IU
  vitaminE: number; // mg
  vitaminK: number; // mcg
  thiamin: number;  // mg (B1)
  riboflavin: number; // mg (B2)
  niacin: number;   // mg (B3)
  vitaminB6: number; // mg
  folate: number;   // mcg
  vitaminB12: number; // mcg
  biotin: number;   // mcg
  pantothenicAcid: number; // mg
}

interface MineralContent {
  calcium: number;  // mg
  iron: number;     // mg
  magnesium: number; // mg
  phosphorus: number; // mg
  potassium: number; // mg
  zinc: number;     // mg
  copper: number;   // mg
  manganese: number; // mg
  selenium: number; // mcg
  iodine: number;   // mcg
}

interface AllergenInfo {
  contains: StandardAllergen[];
  mayContain: StandardAllergen[];
  crossContaminationRisk: CrossContaminationLevel;
  processingFacilityInfo: ProcessingFacilityInfo;
}

enum StandardAllergen {
  MILK = 'MILK',
  EGGS = 'EGGS',
  FISH = 'FISH',
  SHELLFISH = 'SHELLFISH',
  TREE_NUTS = 'TREE_NUTS',
  PEANUTS = 'PEANUTS',
  WHEAT = 'WHEAT',
  SOYBEANS = 'SOYBEANS',
  SESAME = 'SESAME'
}

interface DietaryLabels {
  vegetarian: boolean;
  vegan: boolean;
  glutenFree: boolean;
  dairyFree: boolean;
  nutFree: boolean;
  halal: boolean;
  kosher: boolean;
  organic: boolean;
  localSourced: boolean;
  sustainable: boolean;
}
```

**Enhanced MenuItem Model**:
```typescript
interface MenuItem {
  // Existing fields from Story 2.1
  id: string;
  name: string;
  description: string;
  category: MenuCategory;
  pricing: PricingInfo;
  availability: AvailabilitySchedule;
  images: string[];
  vendorId: string;
  schoolId: string;
  isActive: boolean;
  
  // Enhanced nutritional fields
  nutritionalInfo: NutritionalInfo;
  allergenInfo: AllergenInfo;
  dietaryLabels: DietaryLabels;
  ingredients: Ingredient[];
  nutritionalVersion: number;
  lastNutritionalUpdate: Date;
  nutritionalDataSource: NutritionalDataSource;
}

interface Ingredient {
  id: string;
  name: string;
  percentage?: number;
  origin?: string;
  organic: boolean;
  allergenInfo: AllergenInfo;
  nutritionalContribution: Partial<NutritionalInfo>;
}
```

**Child Nutritional Tracking**:
```typescript
interface ChildNutritionalProfile {
  childId: string;
  parentId: string;
  dateOfBirth: Date;
  gender: 'MALE' | 'FEMALE' | 'OTHER';
  allergies: StandardAllergen[];
  dietaryRestrictions: DietaryLabels;
  nutritionalGoals: NutritionalGoals;
  medicalConsiderations: MedicalConsiderations;
  activityLevel: ActivityLevel;
}

interface NutritionalGoals {
  dailyCalories: number;
  proteinTarget: number;
  fiberTarget: number;
  sugarLimit: number;
  sodiumLimit: number;
  customGoals: CustomNutritionalGoal[];
}

interface NutritionalTracking {
  childId: string;
  date: Date;
  mealsConsumed: ConsumedMeal[];
  dailyTotals: NutritionalInfo;
  goalAchievement: GoalAchievementMetrics;
  recommendations: NutritionalRecommendation[];
}
```

**Database Schema Extensions**:
```sql
-- Enhanced nutritional information with comprehensive micronutrients
CREATE TABLE nutritional_data (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    menu_item_id UUID NOT NULL REFERENCES menu_items(id),
    macronutrients JSONB NOT NULL,
    micronutrients JSONB NOT NULL,
    allergen_info JSONB NOT NULL,
    dietary_labels JSONB NOT NULL,
    data_source VARCHAR(100) NOT NULL,
    verified_by UUID REFERENCES users(id),
    verified_at TIMESTAMP WITH TIME ZONE,
    version INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Child nutritional profiles and tracking
CREATE TABLE child_nutritional_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID NOT NULL REFERENCES users(id),
    parent_id UUID NOT NULL REFERENCES users(id),
    profile_data JSONB NOT NULL,
    nutritional_goals JSONB NOT NULL,
    dietary_restrictions JSONB NOT NULL,
    medical_considerations JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Daily nutritional tracking
CREATE TABLE nutritional_tracking (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID NOT NULL REFERENCES users(id),
    tracking_date DATE NOT NULL,
    meals_consumed JSONB NOT NULL,
    daily_totals JSONB NOT NULL,
    goal_achievement JSONB NOT NULL,
    recommendations JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(child_id, tracking_date)
);

-- Allergen and dietary restriction reference tables
CREATE TABLE standard_allergens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    severity_levels JSONB,
    common_sources TEXT[],
    cross_contamination_risks TEXT[]
);

-- Performance indexes for nutritional queries
CREATE INDEX idx_nutritional_data_menu_item ON nutritional_data(menu_item_id);
CREATE INDEX idx_child_profiles_parent ON child_nutritional_profiles(parent_id);
CREATE INDEX idx_nutritional_tracking_child_date ON nutritional_tracking(child_id, tracking_date);
CREATE INDEX idx_menu_items_dietary_labels ON menu_items USING GIN ((nutritional_info->'dietaryLabels'));
```

**API Endpoints**:
- **GET /menu-items/{id}/nutrition**: Get comprehensive nutritional information
- **PUT /menu-items/{id}/nutrition**: Update nutritional data (admin only)
- **GET /nutrition/allergens**: List standardized allergens
- **GET /nutrition/dietary-labels**: List available dietary restriction labels
- **POST /nutrition/child-profile**: Create child nutritional profile
- **GET /nutrition/child/{childId}/tracking**: Get nutritional tracking history
- **POST /nutrition/calculate-meal**: Calculate nutritional totals for meal combinations
- **GET /nutrition/compliance-report**: Generate regulatory compliance reports

### File Structure Context

**Nutritional Management Files** [Source: architecture.md#unified-project-structure]:
```
apps/api/src/
├── functions/nutrition/
│   ├── getNutritionalInfo.ts        # Comprehensive nutritional data retrieval
│   ├── updateNutritionalData.ts     # Nutritional data management
│   ├── calculateMealNutrition.ts    # Meal nutritional calculations
│   ├── manageChildProfile.ts        # Child nutritional profile management
│   ├── trackDailyNutrition.ts       # Daily nutritional intake tracking
│   ├── generateComplianceReport.ts  # Regulatory compliance reporting
│   └── allergenManagement.ts        # Allergen warning and filtering
├── services/
│   ├── nutritionalCalculationService.ts # Nutritional calculation engine
│   ├── allergenService.ts           # Allergen management service
│   ├── dietaryComplianceService.ts  # Dietary restriction compliance
│   ├── nutritionalAnalyticsService.ts # Analytics and insights
│   └── complianceService.ts         # Regulatory compliance service
├── repositories/
│   ├── nutritionalDataRepository.ts # Nutritional data access
│   ├── childProfileRepository.ts    # Child profile data access
│   └── trackingRepository.ts        # Nutritional tracking data access
└── validation/
    ├── nutritionalSchemas.ts        # Nutritional data validation
    └── profileSchemas.ts            # Child profile validation
```

**Frontend Integration** [Source: architecture.md#frontend-architecture]:
```typescript
// Nutritional components for parent and admin interfaces
src/components/domain/nutrition/
├── NutritionalDashboard.tsx         # Parent nutritional overview
├── ChildNutritionalProfile.tsx      # Child profile management
├── NutritionalTracker.tsx           # Daily intake tracking
├── AllergenManager.tsx              # Allergen warnings and filters
├── DietaryPreferences.tsx           # Dietary restriction management
├── NutritionalCalculator.tsx        # Meal nutritional calculator
├── ComplianceReports.tsx            # Regulatory compliance interface
└── NutritionalInsights.tsx          # Analytics and recommendations
```

### Business Logic Requirements

**Nutritional Calculation Logic**:
- Recipe-based nutritional calculation from ingredient compositions
- Portion size adjustment for age-appropriate servings
- Nutritional goal setting based on WHO and ICMR guidelines for Indian children
- Daily intake aggregation across multiple meals and snacks

**Allergen Management Workflow**:
- Automated allergen detection from ingredient lists
- Cross-contamination risk assessment based on kitchen processes
- Parent notification system for allergen-containing menu items
- Emergency contact integration for severe allergy incidents

**Regulatory Compliance Framework**:
- FSSAI food labeling compliance for nutritional information
- School nutrition program compliance with government guidelines
- Audit trail maintenance for regulatory inspections
- Automated compliance checking and violation alerts

**Personalization Engine**:
- Age-appropriate nutritional recommendations
- Cultural and religious dietary accommodation
- Medical condition-based nutritional adjustments
- Activity level-based caloric requirement calculations

### Previous Story Dependencies

**Dependencies from Story 2.1**:
- **Product Catalog Foundation**: MenuItem models and database schema
- **Category Management**: Product organization for nutritional analysis
- **Image Management**: Visual nutritional information display
- **Search and Filtering**: Nutritional and allergen-based filtering

**Dependencies from Story 2.2**:
- **Menu Planning**: Integration with daily menu nutritional summaries
- **Menu Display**: Nutritional information integration in parent-facing menus
- **Approval Workflow**: Nutritional data verification in menu approval process

**Dependencies from Epic 1**:
- **Authentication**: Parent and child account authentication
- **User Management**: Parent-child relationship management
- **API Gateway**: Secure nutritional data access and management

### Integration Points

**Parent Interface Integration**:
- Real-time nutritional information display during menu browsing
- Child-specific nutritional tracking and goal monitoring
- Allergen alerts and dietary restriction filtering
- Nutritional report generation and sharing with healthcare providers

**School Administration Integration**:
- Nutritional compliance monitoring and reporting
- Population-level nutritional analysis for health programs
- Vendor nutritional data verification and management
- Regulatory compliance documentation and audit preparation

**Healthcare Integration**:
- Integration with pediatric nutrition guidelines
- Medical condition-based dietary recommendation support
- Healthcare provider report sharing capabilities
- Emergency medical information access for severe allergies

**Future Epic Integration**:
- Order validation against child dietary restrictions and allergies
- Payment integration with nutritional program subsidies
- Analytics integration for nutritional trend analysis
- Notification system for nutritional alerts and recommendations

## Testing

### Testing Standards
- **Location**: Nutritional tests in `apps/api/__tests__/functions/nutrition/` and `apps/api/__tests__/services/`
- **Frameworks**: Jest for unit testing, Supertest for API integration testing
- **Coverage**: 95% coverage required for nutritional calculations, 100% for allergen management
- **Database Testing**: Transaction testing for complex nutritional data operations

### Specific Test Requirements
- **Unit Tests**: All nutritional calculation functions, allergen detection, dietary compliance
- **Integration Tests**: Complete nutritional workflows, child profile management, tracking systems
- **Performance Tests**: Nutritional calculation speed, dashboard loading, large dataset queries
- **Security Tests**: Child data protection, parent access controls, data privacy compliance
- **Accuracy Tests**: Nutritional calculation verification, USDA data integration, compliance validation

### Test Scenarios
1. **Nutritional Calculation**: Recipe-based calculations, portion adjustments, goal tracking
2. **Allergen Management**: Detection, warnings, cross-contamination assessment
3. **Dietary Compliance**: Restriction checking, filtering, accommodation recommendations
4. **Child Tracking**: Profile creation, daily intake tracking, goal monitoring
5. **Regulatory Compliance**: FSSAI compliance, audit trail generation, reporting accuracy
6. **Dashboard Functionality**: Real-time updates, personalized recommendations, alert systems
7. **Integration Testing**: Menu display integration, order validation, notification delivery
8. **Performance Testing**: Large dataset handling, calculation speed, dashboard responsiveness

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-02 | 1.0 | Initial story creation with comprehensive nutritional information context | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated during development*

### Debug Log References
*To be populated during development*

### Completion Notes List
*To be populated during development*

### File List
*To be populated during development*

## QA Results

*Results from QA Agent review will be populated here after story implementation*