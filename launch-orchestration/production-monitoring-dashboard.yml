# Epic 5 Production Monitoring Dashboard
# Payment Processing & Billing System Observability

apiVersion: monitoring/v1
kind: Dashboard
metadata:
  name: epic-5-payment-system-monitoring
  namespace: hasivu-production
  labels:
    epic: '5'
    system: 'payment-processing'
    environment: 'production'

spec:
  title: 'Epic 5: Payment Processing & Billing System'
  description: 'Comprehensive monitoring for payment ecosystem with 21 Lambda functions'

  # Dashboard Layout Configuration
  layout:
    grid_size: 12
    height: '100vh'
    refresh_interval: '30s'

  # Alert Thresholds
  alerts:
    critical:
      payment_failure_rate: '>1%'
      api_response_time: '>5s'
      system_error_rate: '>0.5%'
      webhook_failure_rate: '>2%'
    warning:
      payment_failure_rate: '>0.5%'
      api_response_time: '>2s'
      system_error_rate: '>0.1%'
      queue_depth: '>100'

  # Monitoring Panels
  panels:
    # Row 1: System Health Overview
    - title: 'System Health Overview'
      type: 'stat'
      span: 12
      height: 100
      targets:
        - metric: 'payment_success_rate'
          display: 'Payment Success Rate'
          unit: 'percent'
          target: '>99%'
          current_value: "query(aws_lambda_success_rate{service='payments'})"
        - metric: 'system_uptime'
          display: 'System Uptime'
          unit: 'percent'
          target: '>99.9%'
          current_value: "query(aws_lambda_availability{service='hasivu-platform'})"
        - metric: 'active_subscriptions'
          display: 'Active Subscriptions'
          unit: 'count'
          current_value: "query(subscription_count{status='active'})"
        - metric: 'daily_revenue'
          display: 'Daily Revenue'
          unit: 'currency'
          current_value: "query(sum(payment_amount{status='completed'}))"

    # Row 2: Payment Processing Metrics
    - title: 'Payment Processing Performance'
      type: 'graph'
      span: 6
      height: 300
      targets:
        - metric: 'aws_lambda_duration'
          filters:
            function_name:
              - 'hasivu-production-payments-create-order'
              - 'hasivu-production-payments-verify'
              - 'hasivu-production-payments-advanced'
              - 'hasivu-production-payments-webhook-handler'
          display_name: 'Payment API Response Time'
          unit: 'milliseconds'
          thresholds:
            warning: 2000
            critical: 5000
        - metric: 'aws_lambda_invocations'
          filters:
            function_name: 'hasivu-production-payments-*'
          display_name: 'Payment API Requests'
          unit: 'requests/sec'

    - title: 'Payment Success & Error Rates'
      type: 'graph'
      span: 6
      height: 300
      targets:
        - metric: 'payment_success_rate'
          display_name: 'Success Rate'
          unit: 'percent'
          target_line: 99
        - metric: 'payment_error_rate'
          display_name: 'Error Rate'
          unit: 'percent'
          alert_threshold: 1
        - metric: 'payment_fraud_detection_rate'
          display_name: 'Fraud Detection Rate'
          unit: 'percent'

    # Row 3: Subscription & Billing Metrics
    - title: 'Subscription Billing Automation'
      type: 'graph'
      span: 6
      height: 300
      targets:
        - metric: 'aws_lambda_duration'
          filters:
            function_name:
              - 'hasivu-production-billing-automation'
              - 'hasivu-production-subscription-management'
              - 'hasivu-production-dunning-management'
          display_name: 'Billing System Performance'
          unit: 'milliseconds'
        - metric: 'subscription_billing_success_rate'
          display_name: 'Billing Success Rate'
          unit: 'percent'
          target_line: 99

    - title: 'Revenue & Churn Analytics'
      type: 'graph'
      span: 6
      height: 300
      targets:
        - metric: 'monthly_recurring_revenue'
          display_name: 'MRR'
          unit: 'currency'
        - metric: 'customer_churn_rate'
          display_name: 'Churn Rate'
          unit: 'percent'
        - metric: 'customer_lifetime_value'
          display_name: 'CLV'
          unit: 'currency'

    # Row 4: Invoice & Document Processing
    - title: 'Invoice Generation System'
      type: 'graph'
      span: 6
      height: 300
      targets:
        - metric: 'aws_lambda_duration'
          filters:
            function_name:
              - 'hasivu-production-invoice-generator'
              - 'hasivu-production-pdf-generator'
              - 'hasivu-production-invoice-mailer'
          display_name: 'Invoice Processing Time'
          unit: 'milliseconds'
        - metric: 'invoice_generation_rate'
          display_name: 'Invoices Generated'
          unit: 'count/hour'
        - metric: 'invoice_delivery_success_rate'
          display_name: 'Email Delivery Success'
          unit: 'percent'

    - title: 'AI/ML Analytics Performance'
      type: 'graph'
      span: 6
      height: 300
      targets:
        - metric: 'aws_lambda_duration'
          filters:
            function_name:
              - 'hasivu-production-ml-payment-insights'
              - 'hasivu-production-advanced-payment-intelligence'
          display_name: 'ML Processing Time'
          unit: 'milliseconds'
        - metric: 'ml_model_accuracy'
          display_name: 'Model Accuracy'
          unit: 'percent'
          target_line: 95
        - metric: 'fraud_detection_accuracy'
          display_name: 'Fraud Detection Accuracy'
          unit: 'percent'
          target_line: 98

    # Row 5: Infrastructure & Queue Monitoring
    - title: 'Message Queue Health'
      type: 'graph'
      span: 6
      height: 300
      targets:
        - metric: 'aws_sqs_messages_visible'
          filters:
            queue_name: 'payment-retry-queue-production'
          display_name: 'Retry Queue Depth'
          unit: 'count'
          alert_threshold: 100
        - metric: 'aws_sqs_messages_visible'
          filters:
            queue_name: 'payment-dlq-production'
          display_name: 'Dead Letter Queue'
          unit: 'count'
          alert_threshold: 5

    - title: 'Database Performance'
      type: 'graph'
      span: 6
      height: 300
      targets:
        - metric: 'aws_dynamodb_consumed_read_capacity'
          filters:
            table_name: 'payment-webhook-idempotency-production'
          display_name: 'DynamoDB Read Capacity'
          unit: 'units'
        - metric: 'aws_dynamodb_consumed_write_capacity'
          filters:
            table_name: 'payment-webhook-idempotency-production'
          display_name: 'DynamoDB Write Capacity'
          unit: 'units'

    # Row 6: Business Intelligence Dashboard
    - title: 'Real-Time Business Metrics'
      type: 'stat'
      span: 12
      height: 150
      targets:
        - metric: 'realtime_transaction_volume'
          display: 'Transactions (Last Hour)'
          unit: 'count'
        - metric: 'realtime_revenue'
          display: 'Revenue (Last Hour)'
          unit: 'currency'
        - metric: 'active_payment_methods'
          display: 'Active Payment Methods'
          unit: 'count'
        - metric: 'subscription_conversion_rate'
          display: 'Subscription Conversion'
          unit: 'percent'
        - metric: 'average_transaction_value'
          display: 'Avg Transaction Value'
          unit: 'currency'
        - metric: 'customer_acquisition_cost'
          display: 'Customer Acquisition Cost'
          unit: 'currency'

  # Alerting Rules
  alerting:
    rules:
      # Critical Alerts
      - name: 'PaymentSystemCritical'
        condition: 'payment_failure_rate > 1'
        for: '5m'
        severity: 'critical'
        annotations:
          summary: 'Critical: Payment failure rate exceeded 1%'
          description: 'Payment system experiencing high failure rate: {{ $value }}%'
        actions:
          - slack: '#alerts-critical'
          - pagerduty: 'payment-system-oncall'
          - email: 'platform@hasivu.com'

      - name: 'APIResponseTimeCritical'
        condition: "aws_lambda_duration{service='payments'} > 5000"
        for: '2m'
        severity: 'critical'
        annotations:
          summary: 'Critical: Payment API response time exceeded 5 seconds'
        actions:
          - slack: '#alerts-critical'
          - pagerduty: 'payment-system-oncall'

      # Warning Alerts
      - name: 'PaymentSystemWarning'
        condition: 'payment_failure_rate > 0.5'
        for: '10m'
        severity: 'warning'
        annotations:
          summary: 'Warning: Payment failure rate elevated'
        actions:
          - slack: '#alerts-warning'

      - name: 'QueueDepthWarning'
        condition: "aws_sqs_messages_visible{queue='payment-retry-queue'} > 100"
        for: '15m'
        severity: 'warning'
        actions:
          - slack: '#alerts-warning'

  # Custom Metrics & Annotations
  custom_metrics:
    # Business KPIs
    - name: 'payment_success_rate'
      query: 'sum(rate(payment_completed_total[5m])) / sum(rate(payment_attempted_total[5m])) * 100'
      description: 'Percentage of successful payments'

    - name: 'monthly_recurring_revenue'
      query: "sum(subscription_amount{status='active'})"
      description: 'Current MRR from active subscriptions'

    - name: 'customer_churn_rate'
      query: 'sum(rate(subscription_cancelled_total[30d])) / sum(subscription_active_total) * 100'
      description: 'Monthly customer churn rate'

    # Technical Performance
    - name: 'ml_model_accuracy'
      query: "avg(ml_prediction_accuracy{model='fraud_detection'})"
      description: 'Current ML model accuracy for fraud detection'

    - name: 'invoice_generation_rate'
      query: 'sum(rate(invoice_generated_total[1h]))'
      description: 'Invoices generated per hour'

  # Dashboard Annotations
  annotations:
    - name: 'deployments'
      datasource: 'prometheus'
      query: "deployment_timestamp{service='hasivu-platform'}"
      title: 'Deployments'
      color: 'blue'

    - name: 'incidents'
      datasource: 'incident-management'
      query: "incident_timestamp{severity='critical'}"
      title: 'Incidents'
      color: 'red'

    - name: 'epic-milestones'
      datasource: 'project-management'
      query: "epic_completion{epic='5'}"
      title: 'Epic 5 Milestones'
      color: 'green'

# Performance Targets & SLAs
performance_targets:
  payment_success_rate: '>99%'
  api_response_time: '<2s'
  system_uptime: '>99.9%'
  fraud_detection_accuracy: '>98%'
  invoice_generation_time: '<30s'
  subscription_billing_success: '>99.5%'

# Monitoring Best Practices
monitoring_practices:
  data_retention: '90 days'
  metric_collection_interval: '30s'
  alert_evaluation_interval: '1m'
  dashboard_refresh_rate: '30s'
  log_retention: '30 days'
  trace_sampling_rate: '10%'
